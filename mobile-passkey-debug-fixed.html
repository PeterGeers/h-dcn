<!DOCTYPE html>
<html>
<head>
    <title>Mobile Passkey Debug Tool - H-DCN (FIXED v17:47)</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
            font-size: 16px;
            line-height: 1.5;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 { color: #333; margin-bottom: 30px; }
        .section {
            margin: 25px 0;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #fafafa;
        }
        .section h3 {
            margin-top: 0;
            color: #555;
        }
        button {
            background: #007AFF;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin: 8px 4px;
            min-height: 44px; /* iOS touch target */
        }
        button:hover { background: #0056CC; }
        button:disabled { 
            background: #ccc; 
            cursor: not-allowed; 
        }
        input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            margin: 8px 0;
            box-sizing: border-box;
            min-height: 44px; /* iOS touch target */
        }
        .success { 
            color: #28a745; 
            background: #d4edda;
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .error { 
            color: #dc3545; 
            background: #f8d7da;
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .info { 
            color: #17a2b8; 
            background: #d1ecf1;
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .warning {
            color: #856404;
            background: #fff3cd;
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
        }
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 14px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .status-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 15px 0;
        }
        .status-item {
            padding: 10px;
            border-radius: 6px;
            text-align: center;
            font-weight: bold;
        }
        .status-yes { background: #d4edda; color: #155724; }
        .status-no { background: #f8d7da; color: #721c24; }
        .status-unknown { background: #e2e3e5; color: #383d41; }
        
        @media (max-width: 480px) {
            .status-grid {
                grid-template-columns: 1fr;
            }
            body { padding: 10px; }
            .container { padding: 15px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê Mobile Passkey Debug Tool (FIXED v17:47)</h1>
        <p>This debug tool helps identify mobile passkey issues. Run the tests to see what's happening with your passkey authentication.</p>
        
        <div class="section">
            <h3>üì± Browser Info</h3>
            <div id="browser-info"></div>
        </div>

        <div class="section">
            <h3>üîç WebAuthn Support Check</h3>
            <button onclick="checkSupport()">Check Support</button>
            <div id="support-result"></div>
        </div>

        <div class="section">
            <h3>üß™ Test Registration Options</h3>
            <input type="email" id="test-email" placeholder="webmaster@h-dcn.nl" value="webmaster@h-dcn.nl">
            <button onclick="testRegistrationOptions()">Test Registration</button>
            <div id="registration-test-result"></div>
        </div>

        <div class="section">
            <h3>üîê Test Authentication Options</h3>
            <button onclick="testAuthenticationOptions()">Test Authentication</button>
            <div id="authentication-test-result"></div>
        </div>

        <div class="section">
            <h3>üåê Test API Connection</h3>
            <button onclick="testApiConnection()">Test API</button>
            <div id="api-test-result"></div>
        </div>

        <div class="section">
            <h3>üîß Mobile-Specific Tests</h3>
            <button onclick="runMobileTests()">Run Mobile Tests</button>
            <div id="mobile-test-result"></div>
        </div>

        <div class="section">
            <h3>üìã Log Export</h3>
            <button onclick="exportLogs()">Export Clean Logs</button>
            <button onclick="clearAllLogs()">Clear All Logs</button>
            <div id="export-result"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'https://i3if973sp5.execute-api.eu-west-1.amazonaws.com/prod';
        let cleanLogs = []; // Store clean logs without emojis

        // Helper functions for base64url conversion
        function base64urlToUint8Array(base64url) {
            const padding = '='.repeat((4 - base64url.length % 4) % 4);
            const base64 = base64url.replace(/-/g, '+').replace(/_/g, '/') + padding;
            const binary = atob(base64);
            return new Uint8Array(binary.split('').map(c => c.charCodeAt(0)));
        }

        function base64urlToArrayBuffer(base64url) {
            const padding = '='.repeat((4 - base64url.length % 4) % 4);
            const base64 = base64url.replace(/-/g, '+').replace(/_/g, '/') + padding;
            const binary = atob(base64);
            const buffer = new ArrayBuffer(binary.length);
            const view = new Uint8Array(buffer);
            for (let i = 0; i < binary.length; i++) {
                view[i] = binary.charCodeAt(i);
            }
            return buffer;
        }

        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info';
            element.innerHTML += `<div class="${className}">${message}</div>`;
            
            // Store clean version without emojis
            const cleanMessage = message.replace(/[^\x00-\x7F]/g, '').replace(/\s+/g, ' ').trim();
            cleanLogs.push(`[${type.toUpperCase()}] ${cleanMessage}`);
        }

        function clearLog(elementId) {
            document.getElementById(elementId).innerHTML = '';
        }

        function clearAllLogs() {
            const logElements = ['support-result', 'registration-test-result', 'authentication-test-result', 'api-test-result', 'mobile-test-result', 'export-result'];
            logElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) element.innerHTML = '';
            });
            cleanLogs = [];
            log('export-result', 'All logs cleared', 'success');
        }

        function exportLogs() {
            if (cleanLogs.length === 0) {
                log('export-result', 'No logs to export. Run some tests first.', 'warning');
                return;
            }

            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            const filename = `passkey-debug-${timestamp}.txt`;
            
            // Add browser info to logs
            const browserInfo = {
                userAgent: navigator.userAgent,
                webAuthnSupported: !!window.PublicKeyCredential,
                isMobile: /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),
                isSecureContext: window.isSecureContext,
                hostname: window.location.hostname,
                timestamp: new Date().toISOString()
            };

            const logContent = [
                'Mobile Passkey Debug Log',
                '========================',
                `Generated: ${new Date().toISOString()}`,
                `Email: webmaster@h-dcn.nl`,
                '',
                'Browser Info:',
                JSON.stringify(browserInfo, null, 2),
                '',
                'Test Results:',
                ...cleanLogs,
                '',
                'End of Log'
            ].join('\n');

            // Create and download file
            const blob = new Blob([logContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            log('export-result', `Clean logs exported as ${filename}`, 'success');
            
            // Also display in the UI for copying
            document.getElementById('export-result').innerHTML += `
                <div class="info">
                    <strong>Clean Log Content (for copying):</strong>
                    <pre style="max-height: 300px; overflow-y: auto;">${logContent}</pre>
                </div>
            `;
        }

        function formatTime() {
            return new Date().toLocaleTimeString();
        }

        function showBrowserInfo() {
            const info = {
                userAgent: navigator.userAgent,
                webAuthnSupported: !!window.PublicKeyCredential,
                platformAuthenticator: 'unknown',
                isMobile: /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),
                recommendedAttachment: 'unknown',
                supportsCrossDevice: false
            };

            // Check platform authenticator
            if (window.PublicKeyCredential && PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable) {
                PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable()
                    .then(available => {
                        info.platformAuthenticator = available;
                        info.recommendedAttachment = available ? 'platform' : 'cross-platform';
                        updateBrowserInfo(info);
                    });
            }

            // Check conditional mediation (cross-device support)
            if (window.PublicKeyCredential && PublicKeyCredential.isConditionalMediationAvailable) {
                PublicKeyCredential.isConditionalMediationAvailable()
                    .then(available => {
                        info.supportsCrossDevice = available;
                        updateBrowserInfo(info);
                    });
            }

            updateBrowserInfo(info);
        }

        function updateBrowserInfo(info) {
            const browserInfoDiv = document.getElementById('browser-info');
            browserInfoDiv.innerHTML = `
                <div class="info">Browser Info:
                    <pre>${JSON.stringify(info, null, 2)}</pre>
                </div>
            `;
            
            // Log to console for debugging
            console.log(`${formatTime()}:Browser Info:`, info);
        }

        function checkSupport() {
            clearLog('support-result');
            log('support-result', `${formatTime()}:Testing passkey support...`, 'info');
            
            if (!window.PublicKeyCredential) {
                log('support-result', 'WebAuthn not supported in this browser', 'error');
                return;
            }
            
            log('support-result', `${formatTime()}:WebAuthn supported: true`, 'success');
            
            const checks = [];
            
            // Platform authenticator check
            if (PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable) {
                checks.push(
                    PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable()
                        .then(available => {
                            log('support-result', `Platform authenticator: ${available ? 'Available' : 'Not available'}`, available ? 'success' : 'warning');
                            return { platformAuth: available };
                        })
                );
            }
            
            // Conditional mediation check
            if (PublicKeyCredential.isConditionalMediationAvailable) {
                checks.push(
                    PublicKeyCredential.isConditionalMediationAvailable()
                        .then(available => {
                            log('support-result', `Conditional mediation: ${available ? 'Supported' : 'Not supported'}`, available ? 'success' : 'info');
                            return { conditionalMediation: available };
                        })
                );
            }
            
            Promise.all(checks).then(results => {
                log('support-result', 'Support check complete', 'success');
            });
        }

        async function testRegistrationOptions() {
            clearLog('registration-test-result');
            const email = document.getElementById('test-email').value;
            
            if (!email) {
                log('registration-test-result', 'Please enter an email address', 'error');
                return;
            }
            
            log('registration-test-result', `${formatTime()}:Testing passkey registration...`, 'info');
            
            try {
                // Test API call
                const response = await fetch(`${API_BASE}/auth/passkey/register/begin`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: email })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    log('registration-test-result', `API Error: ${data.error}`, 'error');
                    return;
                }
                
                log('registration-test-result', `${formatTime()}:Registration options received`, 'success');
                log('registration-test-result', `${formatTime()}:Registration options: ${JSON.stringify(data)}`, 'info');
                console.log(`${formatTime()}:Registration options received:`, data);
                
                // Validate required fields
                if (!data.challenge) {
                    log('registration-test-result', 'Missing challenge in response', 'error');
                    return;
                }
                
                if (!data.user || !data.user.id) {
                    log('registration-test-result', 'Missing user information in response', 'error');
                    return;
                }
                
                // Build WebAuthn registration options
                const registrationOptions = {
                    challenge: base64urlToUint8Array(data.challenge),
                    rp: {
                        name: 'H-DCN Portal',
                        id: window.location.hostname
                    },
                    user: {
                        id: typeof data.user.id === 'string' ? 
                            new TextEncoder().encode(data.user.id) : 
                            base64urlToUint8Array(data.user.id),
                        name: data.user.name,
                        displayName: data.user.displayName
                    },
                    pubKeyCredParams: data.pubKeyCredParams || [
                        { type: 'public-key', alg: -7 },
                        { type: 'public-key', alg: -257 }
                    ],
                    authenticatorSelection: data.authenticatorSelection || {
                        userVerification: 'preferred',
                        requireResidentKey: false
                    },
                    timeout: data.timeout || 60000,
                    attestation: data.attestation || 'none'
                };
                
                log('registration-test-result', `${formatTime()}:Attempting to create passkey...`, 'info');
                
                const credential = await navigator.credentials.create({
                    publicKey: registrationOptions
                });
                
                log('registration-test-result', `${formatTime()}:WebAuthn registration successful!`, 'success');
                log('registration-test-result', `Credential ID: ${credential.id}`, 'success');
                
                // Complete registration by sending credential to backend
                log('registration-test-result', `${formatTime()}:Completing registration with backend...`, 'info');
                
                try {
                    const completionResponse = await fetch(`${API_BASE}/auth/passkey/register/complete`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            email: email,
                            credential: {
                                id: credential.id,
                                rawId: credential.id,
                                type: credential.type,
                                response: {
                                    attestationObject: Array.from(new Uint8Array(credential.response.attestationObject)),
                                    clientDataJSON: Array.from(new Uint8Array(credential.response.clientDataJSON))
                                }
                            }
                        })
                    });
                    
                    const completionData = await completionResponse.json();
                    
                    if (completionResponse.ok) {
                        log('registration-test-result', `${formatTime()}:Registration completed successfully!`, 'success');
                        log('registration-test-result', `Backend confirmed credential storage`, 'success');
                    } else {
                        log('registration-test-result', `${formatTime()}:Registration completion failed: ${completionData.error}`, 'error');
                    }
                    
                } catch (completionError) {
                    log('registration-test-result', `${formatTime()}:Registration completion error: ${completionError.message}`, 'error');
                }
                
            } catch (error) {
                log('registration-test-result', `${formatTime()}:Registration test failed: ${error.message}`, 'error');
                console.error(`${formatTime()}:Registration test error:`, error);
                
                // Additional debugging info
                if (error.name === 'NotSupportedError') {
                    log('registration-test-result', 'This might be due to missing platform authenticator or unsupported parameters', 'warning');
                } else if (error.name === 'SecurityError') {
                    log('registration-test-result', 'This might be due to invalid origin or insecure context', 'warning');
                } else if (error.name === 'InvalidStateError') {
                    log('registration-test-result', 'A credential might already exist for this user', 'warning');
                }
            }
        }

        async function testAuthenticationOptions() {
            clearLog('authentication-test-result');
            log('authentication-test-result', `${formatTime()}:Testing passkey support...`, 'info');
            
            if (!window.PublicKeyCredential) {
                log('authentication-test-result', 'WebAuthn not supported', 'error');
                return;
            }
            
            log('authentication-test-result', `${formatTime()}:WebAuthn supported: true`, 'success');
            
            // Check platform authenticator
            try {
                const available = await PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable();
                log('authentication-test-result', `${formatTime()}:Platform authenticator available: ${available}`, available ? 'success' : 'warning');
            } catch (error) {
                log('authentication-test-result', `${formatTime()}:Could not check platform authenticator: ${error.message}`, 'warning');
            }
            
            log('authentication-test-result', `${formatTime()}:Checking if user has passkey registered...`, 'info');
            
            try {
                const response = await fetch(`${API_BASE}/auth/passkey/authenticate/begin`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        email: 'webmaster@h-dcn.nl',
                        crossDevice: true  // Enable cross-device for mobile
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    if (data.error && data.error.includes('No credentials found')) {
                        log('authentication-test-result', `${formatTime()}:No passkey registered for this user`, 'warning');
                    } else {
                        log('authentication-test-result', `${formatTime()}:API Error: ${data.error}`, 'error');
                    }
                    return;
                }
                
                log('authentication-test-result', `${formatTime()}:User has passkey registered`, 'success');
                log('authentication-test-result', `${formatTime()}:Authentication options received: ${JSON.stringify(data)}`, 'success');
                
                // Show credential details for debugging
                if (data.allowCredentials && data.allowCredentials.length > 0) {
                    log('authentication-test-result', `Found ${data.allowCredentials.length} stored credential(s)`, 'info');
                    data.allowCredentials.forEach((cred, index) => {
                        log('authentication-test-result', `  Credential ${index + 1}: ${cred.id.substring(0, 20)}...`, 'info');
                    });
                } else {
                    log('authentication-test-result', `No stored credentials found (allowCredentials is empty)`, 'warning');
                    if (data.crossDevice) {
                        log('authentication-test-result', `Cross-device mode enabled - any credential allowed`, 'info');
                    } else {
                        log('authentication-test-result', `Same-device mode - this may cause authentication failure`, 'warning');
                    }
                }
                
                console.log(`${formatTime()}:Authentication options received:`, data);
                
                // Convert allowCredentials IDs from base64url strings to ArrayBuffers
                const processedAllowCredentials = (data.allowCredentials || []).map(cred => ({
                    ...cred,
                    id: base64urlToArrayBuffer(cred.id)
                }));
                
                // Test WebAuthn call
                const authOptions = {
                    challenge: base64urlToUint8Array(data.challenge),
                    allowCredentials: processedAllowCredentials,
                    userVerification: data.userVerification || 'preferred',
                    timeout: data.timeout || 60000
                };
                
                log('authentication-test-result', 'Attempting WebAuthn authentication...', 'info');
                
                const assertion = await navigator.credentials.get({
                    publicKey: authOptions
                });
                
                log('authentication-test-result', 'WebAuthn authentication successful!', 'success');
                log('authentication-test-result', `Assertion ID: ${assertion.id}`, 'success');
                
                // Complete authentication by sending assertion to backend
                log('authentication-test-result', `${formatTime()}:Completing authentication with backend...`, 'info');
                
                try {
                    const completionResponse = await fetch(`${API_BASE}/auth/passkey/authenticate/complete`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            email: 'webmaster@h-dcn.nl',
                            credential: {
                                id: assertion.id,
                                rawId: assertion.id,
                                type: assertion.type,
                                response: {
                                    authenticatorData: Array.from(new Uint8Array(assertion.response.authenticatorData)),
                                    clientDataJSON: Array.from(new Uint8Array(assertion.response.clientDataJSON)),
                                    signature: Array.from(new Uint8Array(assertion.response.signature)),
                                    userHandle: assertion.response.userHandle ? Array.from(new Uint8Array(assertion.response.userHandle)) : null
                                }
                            }
                        })
                    });
                    
                    const completionData = await completionResponse.json();
                    
                    if (completionResponse.ok) {
                        log('authentication-test-result', `${formatTime()}:Authentication completed successfully!`, 'success');
                        log('authentication-test-result', `Received JWT tokens`, 'success');
                    } else {
                        log('authentication-test-result', `${formatTime()}:Authentication completion failed: ${completionData.error}`, 'error');
                    }
                    
                } catch (completionError) {
                    log('authentication-test-result', `${formatTime()}:Authentication completion error: ${completionError.message}`, 'error');
                }
                
            } catch (error) {
                log('authentication-test-result', `Authentication test failed: ${error.message}`, 'error');
                console.error('Authentication test error:', error);
                
                // Additional debugging info
                if (error.name === 'NotAllowedError') {
                    log('authentication-test-result', 'User cancelled or no matching credentials found', 'warning');
                } else if (error.name === 'SecurityError') {
                    log('authentication-test-result', 'This might be due to invalid origin or insecure context', 'warning');
                }
            }
        }

        async function testApiConnection() {
            clearLog('api-test-result');
            log('api-test-result', `${formatTime()}:Testing API connection...`, 'info');
            
            try {
                const response = await fetch(`${API_BASE}/auth/passkey/authenticate/begin`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: 'test@example.com' })
                });
                
                const data = await response.json();
                
                log('api-test-result', `API Response: ${response.status}`, response.ok ? 'success' : 'warning');
                log('api-test-result', `Response: ${JSON.stringify(data, null, 2)}`, 'info');
                
            } catch (error) {
                log('api-test-result', `API Connection Error: ${error.message}`, 'error');
            }
        }

        async function runMobileTests() {
            clearLog('mobile-test-result');
            log('mobile-test-result', `${formatTime()}:Running mobile-specific tests...`, 'info');
            
            // Test 1: Touch events
            log('mobile-test-result', `Touch events supported: ${'ontouchstart' in window ? 'Yes' : 'No'}`, 'info');
            
            // Test 2: Viewport
            const viewport = {
                width: window.innerWidth,
                height: window.innerHeight,
                devicePixelRatio: window.devicePixelRatio || 1
            };
            log('mobile-test-result', `Viewport: ${viewport.width}x${viewport.height} (ratio: ${viewport.devicePixelRatio})`, 'info');
            
            // Test 3: User agent
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            log('mobile-test-result', `Mobile detected: ${isMobile ? 'Yes' : 'No'}`, 'info');
            
            // Test 4: Secure context
            log('mobile-test-result', `Secure context: ${window.isSecureContext ? 'Yes' : 'No'}`, window.isSecureContext ? 'success' : 'error');
            
            // Test 5: WebAuthn with mobile-optimized options
            if (window.PublicKeyCredential) {
                try {
                    log('mobile-test-result', 'Testing mobile-optimized WebAuthn options...', 'info');
                    
                    const mobileOptions = {
                        challenge: new Uint8Array(32),
                        rp: { name: 'H-DCN Portal', id: window.location.hostname },
                        user: {
                            id: new TextEncoder().encode('mobile-test'),
                            name: 'mobile-test',
                            displayName: 'Mobile Test'
                        },
                        pubKeyCredParams: [{ type: 'public-key', alg: -7 }],
                        authenticatorSelection: {
                            userVerification: 'preferred',
                            requireResidentKey: false
                            // No authenticatorAttachment for mobile compatibility
                        },
                        timeout: 120000, // Longer timeout for mobile
                        attestation: 'none'
                    };
                    
                    // Don't actually create, just test the options
                    log('mobile-test-result', 'Mobile WebAuthn options validated', 'success');
                    log('mobile-test-result', `Options: ${JSON.stringify(mobileOptions, null, 2)}`, 'info');
                    
                } catch (error) {
                    log('mobile-test-result', `Mobile WebAuthn test failed: ${error.message}`, 'error');
                }
            }
            
            log('mobile-test-result', 'Mobile tests complete', 'success');
        }

        // Initialize on load
        window.onload = function() {
            showBrowserInfo();
            checkSupport();
            
            // Log initial state
            console.log(`${formatTime()}:Mobile Passkey Debug Tool loaded`);
        };
    </script>
</body>
</html>
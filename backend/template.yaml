AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: >
  python-crud-api-test

  Sample SAM Template for python-crud-api-test
  # Updated to remove Cognito function temporarily


Parameters:
  # EXISTING USER POOL - DO NOT CREATE NEW ONES!
  ExistingUserPoolId:
    Type: String
    Default: "eu-west-1_OAT3oPCIm"
    Description: "Existing Cognito User Pool ID (contains all users)"
  
  ExistingUserPoolClientId:
    Type: String
    Default: "6unl8mg5tbv5r727vc39d847vn"
    Description: "Existing Cognito User Pool Client ID"
  Environment:
    Type: String
    Default: "dev"
    AllowedValues: ["dev", "test", "prod"]
    Description: "Environment name"
  Table:
    Type: String
    Default: Producten
  Region:
    Type: String
    Default: eu-west-1
  MembersTable:
    Type: String
    Default: Members
  PaymentsTable:
    Type: String
    Default: Payments
  EventsTable:
    Type: String
    Default: Events
  MembershipsTable:
    Type: String
    Default: Memberships
  CartsTable:
    Type: String
    Default: Carts
  OrdersTable:
    Type: String
    Default: Orders
  DefaultTempPassword:
    Type: String
    NoEcho: true
    Description: Default temporary password for new Cognito users
    Default: TempPass123!
  ForceUpdate:
    Type: String
    Default: "2025-12-28"
  
  # Email template customization parameters
  OrganizationName:
    Type: String
    Default: "Harley-Davidson Club Nederland"
    Description: "Organization name used in email templates"
  
  OrganizationWebsite:
    Type: String
    Default: "https://portal.h-dcn.nl"
    Description: "Organization website URL used in email templates"
  
  OrganizationEmail:
    Type: String
    Default: "webhulpje@h-dcn.nl"
    Description: "Organization contact email used in email templates"
  
  OrganizationShortName:
    Type: String
    Default: "H-DCN"
    Description: "Organization short name used in email templates"
  
  # Account recovery specific parameters
  SupportPhoneNumber:
    Type: String
    Default: "+31 (0)20 123 4567"
    Description: "Support phone number for account recovery assistance"
  
  RecoveryPageUrl:
    Type: String
    Default: "/recovery"
    Description: "Relative URL path for the account recovery page"
  
  HelpPageUrl:
    Type: String
    Default: "/help/passwordless-recovery"
    Description: "Relative URL path for the passwordless recovery help page"

  # Google Workspace SSO Configuration
  GoogleClientId:
    Type: String
    NoEcho: true
    Description: "Google OAuth 2.0 Client ID for Workspace SSO"
    Default: ""
  
  GoogleClientSecret:
    Type: String
    NoEcho: true
    Description: "Google OAuth 2.0 Client Secret for Workspace SSO"
    Default: ""

Globals:
  Function:
    Timeout: 10
    MemorySize: 128
    Tracing: Active
    Architectures:
      - x86_64
    Environment:
      Variables:
        DYNAMODB_TABLE: !Ref Table
        REGION_NAME: !Ref Region
        PYTHONPATH: /opt/python
  Api:
    TracingEnabled: True
    Cors:
      AllowMethods: "'OPTIONS,GET,POST,PUT,DELETE,PATCH'"
      AllowHeaders: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token,X-Enhanced-Groups,x-requested-with'"
      AllowOrigin: "'*'"
      AllowCredentials: false

Resources:
  
  # Lambda Layer for Shared Authentication
  AuthLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: !Sub "${AWS::StackName}-auth-layer"
      Description: "Shared authentication utilities for H-DCN Lambda functions"
      ContentUri: layers/auth-layer/
      CompatibleRuntimes:
        - python3.11
      RetentionPolicy: Retain

  # S3 Bucket for Email Templates
  EmailTemplatesBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub "${AWS::StackName}-email-templates"
      VersioningConfiguration:
        Status: Enabled
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      Tags:
        - Key: Application
          Value: H-DCN
        - Key: Purpose
          Value: EmailTemplates

  # Using existing Cognito User Pool: eu-west-1_OAT3oPCIm (contains all users)
  # User Pool and Client are referenced via ExistingUserPoolId and ExistingUserPoolClientId parameters

  # Using existing Cognito User Pool: eu-west-1_OAT3oPCIm (contains all users and groups)
  # Groups and Identity Provider are managed by the 'webshop-backend' stack
  # This stack only references the existing User Pool and Client IDs

  # Lambda function for custom Cognito email messages
  CognitoCustomMessageFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handler/cognito_custom_message
      Handler: app.lambda_handler
      Runtime: python3.11
      Layers:
        - !Ref AuthLayer
      Role: !GetAtt CognitoLambdaRole.Arn
      Environment:
        Variables:
          ORGANIZATION_NAME: !Ref OrganizationName
          ORGANIZATION_WEBSITE: !Ref OrganizationWebsite
          ORGANIZATION_EMAIL: !Ref OrganizationEmail
          ORGANIZATION_SHORT_NAME: !Ref OrganizationShortName
          # Account recovery specific settings
          RECOVERY_URL: !Sub "${OrganizationWebsite}${RecoveryPageUrl}"
          HELP_URL: !Sub "${OrganizationWebsite}${HelpPageUrl}"
          SUPPORT_PHONE: !Ref SupportPhoneNumber
          # S3 Template Bucket
          EMAIL_TEMPLATES_BUCKET: !Ref EmailTemplatesBucket

  # Lambda function for post-confirmation actions
  CognitoPostConfirmationFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handler/cognito_post_confirmation
      Handler: app.lambda_handler
      Runtime: python3.11
      Layers:
        - !Ref AuthLayer
      Role: !GetAtt CognitoLambdaRole.Arn
      Environment:
        Variables:
          DEFAULT_MEMBER_GROUP: hdcnLeden
          ORGANIZATION_NAME: !Ref OrganizationName
          ORGANIZATION_WEBSITE: !Ref OrganizationWebsite
          ORGANIZATION_EMAIL: !Ref OrganizationEmail
          ORGANIZATION_SHORT_NAME: !Ref OrganizationShortName
          MEMBERS_TABLE_NAME: !Ref MembersTable

  # Lambda function for post-authentication actions (handles Google SSO role assignment)
  CognitoPostAuthenticationFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handler/cognito_post_authentication
      Handler: app.lambda_handler
      Runtime: python3.11
      Layers:
        - !Ref AuthLayer
      Role: !GetAtt CognitoLambdaRole.Arn
      Environment:
        Variables:
          DEFAULT_MEMBER_GROUP: hdcnLeden
          ORGANIZATION_NAME: !Ref OrganizationName
          ORGANIZATION_WEBSITE: !Ref OrganizationWebsite
          ORGANIZATION_EMAIL: !Ref OrganizationEmail
          ORGANIZATION_SHORT_NAME: !Ref OrganizationShortName
          MEMBERS_TABLE_NAME: !Ref MembersTable

  # IAM Role for Cognito Lambda triggers
  CognitoLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        - arn:aws:iam::aws:policy/AWSXRayDaemonWriteAccess
      Policies:
        - PolicyName: CognitoLambdaAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - cognito-idp:AdminAddUserToGroup
                  - cognito-idp:AdminGetUser
                  - cognito-idp:ListUsers
                  - cognito-idp:AdminListGroupsForUser
                Resource: 
                  - !Sub "arn:aws:cognito-idp:${AWS::Region}:${AWS::AccountId}:userpool/*"
        - PolicyName: S3EmailTemplatesAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                Resource: 
                  - !Sub "${EmailTemplatesBucket.Arn}/*"
              - Effect: Allow
                Action:
                  - s3:ListBucket
                Resource: 
                  - !GetAtt EmailTemplatesBucket.Arn
        - PolicyName: SESEmailAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - ses:SendEmail
                  - ses:SendRawEmail
                Resource: "*"

  # Lambda permissions for Cognito triggers (using existing User Pool)
  CognitoCustomMessagePermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !GetAtt CognitoCustomMessageFunction.Arn
      Action: lambda:InvokeFunction
      Principal: cognito-idp.amazonaws.com
      SourceArn: !Sub "arn:aws:cognito-idp:${AWS::Region}:${AWS::AccountId}:userpool/${ExistingUserPoolId}"

  CognitoPostConfirmationPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !GetAtt CognitoPostConfirmationFunction.Arn
      Action: lambda:InvokeFunction
      Principal: cognito-idp.amazonaws.com
      SourceArn: !Sub "arn:aws:cognito-idp:${AWS::Region}:${AWS::AccountId}:userpool/${ExistingUserPoolId}"

  CognitoPostAuthenticationPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !GetAtt CognitoPostAuthenticationFunction.Arn
      Action: lambda:InvokeFunction
      Principal: cognito-idp.amazonaws.com
      SourceArn: !Sub "arn:aws:cognito-idp:${AWS::Region}:${AWS::AccountId}:userpool/${ExistingUserPoolId}"
  MyApi:
    Type: AWS::Serverless::Api
    Properties:
      StageName: !Ref Environment
      Cors:
        AllowMethods: "'OPTIONS,GET,POST,PUT,DELETE,PATCH'"
        AllowHeaders: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token,X-Enhanced-Groups,x-requested-with'"
        AllowOrigin: "'*'"
        AllowCredentials: false

  # IAM Role for DynamoDB access (updated for GSI)
  DynamoDBRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        - arn:aws:iam::aws:policy/AWSXRayDaemonWriteAccess
      Policies:
        - PolicyName: DynamoDBAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:GetItem
                  - dynamodb:PutItem
                  - dynamodb:UpdateItem
                  - dynamodb:DeleteItem
                  - dynamodb:Scan
                  - dynamodb:Query
                Resource:
                  - !Sub "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${Table}"
                  - !Sub "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${MembersTable}"
                  - !Sub "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${PaymentsTable}"
                  - !Sub "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${EventsTable}"
                  - !Sub "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${MembershipsTable}"
                  - !Sub "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${CartsTable}"
                  - !Sub "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${OrdersTable}"
                  - !Sub "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${PaymentsTable}/index/*"
                  - !Sub "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${OrdersTable}/index/*"
                  - !Sub "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${CartsTable}/index/*"
                  - !Sub "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${MembersTable}/index/*"
                  - !Sub "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${EventsTable}/index/*"
                  - !Sub "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${MembershipsTable}/index/*"
        - PolicyName: S3AnalyticsAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:PutObject
                  - s3:PutObjectAcl
                  - s3:GetObject
                  - s3:DeleteObject
                Resource:
                  - "arn:aws:s3:::my-hdcn-bucket/analytics/*"
              - Effect: Allow
                Action:
                  - s3:ListBucket
                Resource:
                  - "arn:aws:s3:::my-hdcn-bucket"
                Condition:
                  StringLike:
                    "s3:prefix": "analytics/*"
        - PolicyName: CognitoReadAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - cognito-idp:AdminGetUser
                  - cognito-idp:AdminListGroupsForUser
                Resource:
                  - !Sub "arn:aws:cognito-idp:${AWS::Region}:${AWS::AccountId}:userpool/eu-west-1_OAT3oPCIm"

  # IAM Role for Cognito Admin access
  CognitoAdminRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        - arn:aws:iam::aws:policy/AWSXRayDaemonWriteAccess
      Policies:
        - PolicyName: CognitoAdminAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - cognito-idp:ListUsers
                  - cognito-idp:AdminCreateUser
                  - cognito-idp:AdminDeleteUser
                  - cognito-idp:AdminGetUser
                  - cognito-idp:AdminUpdateUserAttributes
                  - cognito-idp:AdminAddUserToGroup
                  - cognito-idp:AdminRemoveUserFromGroup
                  - cognito-idp:AdminListGroupsForUser
                  - cognito-idp:ListGroups
                  - cognito-idp:CreateGroup
                  - cognito-idp:DeleteGroup
                  - cognito-idp:ListUsersInGroup
                  - cognito-idp:DescribeUserPool
                  - cognito-idp:AdminSetUserPassword
                  - cognito-idp:AdminInitiateAuth
                  - cognito-idp:AdminRespondToAuthChallenge
                  - cognito-idp:GetGroup
                  - cognito-idp:UpdateGroup
                Resource: 
                  - !Sub "arn:aws:cognito-idp:${AWS::Region}:${AWS::AccountId}:userpool/${ExistingUserPoolId}"
                  - !Sub "arn:aws:cognito-idp:${AWS::Region}:${AWS::AccountId}:userpool/${ExistingUserPoolId}/*"

  InsertProductFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handler/insert_product
      Handler: app.lambda_handler
      Runtime: python3.11
      Layers:
        - !Ref AuthLayer
      Role: !GetAtt DynamoDBRole.Arn
      Events:
        InsertProduct:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /insert-product/
            Method: post
            
  DeleteProductFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handler/delete_product
      Handler: app.lambda_handler
      Runtime: python3.11
      Layers:
        - !Ref AuthLayer
      Role: !GetAtt DynamoDBRole.Arn
      Events:
        DeletePost:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /delete-product/{id}
            Method: delete

  GetProductByIdFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handler/get_product_byid
      Handler: app.lambda_handler
      Runtime: python3.11
      Layers:
        - !Ref AuthLayer
      Role: !GetAtt DynamoDBRole.Arn
      Events:
        GetPost:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /getproduct-byid/{id}
            Method: get

  scanProductFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handler/scan_product
      Handler: app.lambda_handler
      Runtime: python3.11
      Layers:
        - !Ref AuthLayer
      Role: !GetAtt DynamoDBRole.Arn
      Events:
        ListProducts:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /scan-product/
            Method: get

  UpdateProductFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handler/update_product
      Handler: app.lambda_handler
      Runtime: python3.11
      Layers:
        - !Ref AuthLayer
      Role: !GetAtt DynamoDBRole.Arn
      Events:
        UpdatePost:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /update-product/{id}
            Method: put

  # Member Management Functions
  CreateMemberFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handler/create_member
      Handler: app.lambda_handler
      Runtime: python3.11
      Layers:
        - !Ref AuthLayer
      Role: !GetAtt DynamoDBRole.Arn
      Events:
        CreateMember:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /members
            Method: post

  GetMembersFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handler/get_members
      Handler: app.lambda_handler
      Runtime: python3.11
      Layers:
        - !Ref AuthLayer
      Role: !GetAtt DynamoDBRole.Arn
      Events:
        GetMembers:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /members
            Method: get

  GetMemberByIdFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handler/get_member_byid
      Handler: app.lambda_handler
      Runtime: python3.11
      Layers:
        - !Ref AuthLayer
      Role: !GetAtt DynamoDBRole.Arn
      Events:
        GetMemberById:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /members/{id}
            Method: get

  GetMemberSelfFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handler/get_member_self
      Handler: app.lambda_handler
      Runtime: python3.11
      Layers:
        - !Ref AuthLayer
      Role: !GetAtt DynamoDBRole.Arn
      Events:
        GetMemberSelf:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /members/me
            Method: get
        UpdateMemberSelf:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /members/me
            Method: put
        CreateMemberSelf:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /members/me
            Method: post

  UpdateMemberFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handler/update_member
      Handler: app.lambda_handler
      Runtime: python3.11
      Layers:
        - !Ref AuthLayer
      Role: !GetAtt DynamoDBRole.Arn
      Events:
        UpdateMember:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /members/{id}
            Method: put

  DeleteMemberFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handler/delete_member
      Handler: app.lambda_handler
      Runtime: python3.11
      Layers:
        - !Ref AuthLayer
      Role: !GetAtt DynamoDBRole.Arn
      Events:
        DeleteMember:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /members/{id}
            Method: delete

  # Payment Functions
  CreatePaymentFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handler/create_payment
      Handler: app.lambda_handler
      Runtime: python3.11
      Layers:
        - !Ref AuthLayer
      Role: !GetAtt DynamoDBRole.Arn
      Events:
        CreatePayment:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /payments
            Method: post

  GetPaymentsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handler/get_payments
      Handler: app.lambda_handler
      Runtime: python3.11
      Layers:
        - !Ref AuthLayer
      Role: !GetAtt DynamoDBRole.Arn
      Events:
        GetPayments:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /payments
            Method: get

  GetPaymentByIdFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handler/get_payment_byid
      Handler: app.lambda_handler
      Runtime: python3.11
      Layers:
        - !Ref AuthLayer
      Role: !GetAtt DynamoDBRole.Arn
      Events:
        GetPaymentById:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /payments/{payment_id}
            Method: get

  UpdatePaymentFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handler/update_payment
      Handler: app.lambda_handler
      Runtime: python3.11
      Layers:
        - !Ref AuthLayer
      Role: !GetAtt DynamoDBRole.Arn
      Events:
        UpdatePayment:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /payments/{payment_id}
            Method: put

  DeletePaymentFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handler/delete_payment
      Handler: app.lambda_handler
      Runtime: python3.11
      Layers:
        - !Ref AuthLayer
      Role: !GetAtt DynamoDBRole.Arn
      Events:
        DeletePayment:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /payments/{payment_id}
            Method: delete

  GetMemberPaymentsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handler/get_member_payments
      Handler: app.lambda_handler
      Runtime: python3.11
      Layers:
        - !Ref AuthLayer
      Role: !GetAtt DynamoDBRole.Arn
      Events:
        GetMemberPayments:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /payments/member/{member_id}
            Method: get

  # Event Functions
  CreateEventFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handler/create_event
      Handler: app.lambda_handler
      Runtime: python3.11
      Layers:
        - !Ref AuthLayer
      Role: !GetAtt DynamoDBRole.Arn
      Events:
        CreateEvent:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /events
            Method: post

  GetEventsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handler/get_events
      Handler: app.lambda_handler
      Runtime: python3.11
      Layers:
        - !Ref AuthLayer
      Role: !GetAtt DynamoDBRole.Arn
      Events:
        GetEvents:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /events
            Method: get

  # Cognito Admin Function
  HdcnCognitoAdminFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handler/hdcn_cognito_admin
      Handler: app.lambda_handler
      Runtime: python3.11
      Layers:
        - !Ref AuthLayer
      Role: !GetAtt CognitoAdminRole.Arn
      Environment:
        Variables:
          DEFAULT_TEMP_PASSWORD: !Ref DefaultTempPassword
          COGNITO_USER_POOL_ID: !Ref ExistingUserPoolId
          COGNITO_USER_POOL_CLIENT_ID: !Ref ExistingUserPoolClientId
      Events:
        CognitoRoot:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /cognito
            Method: ANY
        CognitoProxy:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /cognito/{proxy+}
            Method: ANY
        AuthRoot:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /auth
            Method: ANY
        AuthProxy:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /auth/{proxy+}
            Method: ANY

  # Membership Type Functions
  GetMembershipsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handler/get_memberships
      Handler: app.lambda_handler
      Runtime: python3.11
      Layers:
        - !Ref AuthLayer
      Role: !GetAtt DynamoDBRole.Arn
      Events:
        GetMemberships:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /memberships
            Method: get

  CreateMembershipFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handler/create_membership
      Handler: app.lambda_handler
      Runtime: python3.11
      Layers:
        - !Ref AuthLayer
      Role: !GetAtt DynamoDBRole.Arn
      Events:
        CreateMembership:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /memberships
            Method: post

  GetMembershipByIdFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handler/get_membership_byid
      Handler: app.lambda_handler
      Runtime: python3.11
      Layers:
        - !Ref AuthLayer
      Role: !GetAtt DynamoDBRole.Arn
      Events:
        GetMembershipById:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /memberships/{id}
            Method: get

  UpdateMembershipFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handler/update_membership
      Handler: app.lambda_handler
      Runtime: python3.11
      Layers:
        - !Ref AuthLayer
      Role: !GetAtt DynamoDBRole.Arn
      Events:
        UpdateMembership:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /memberships/{id}
            Method: put

  DeleteMembershipFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handler/delete_membership
      Handler: app.lambda_handler
      Runtime: python3.11
      Layers:
        - !Ref AuthLayer
      Role: !GetAtt DynamoDBRole.Arn
      Events:
        DeleteMembership:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /memberships/{id}
            Method: delete

  # Cart Functions
  CreateCartFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handler/create_cart
      Handler: app.lambda_handler
      Runtime: python3.11
      Layers:
        - !Ref AuthLayer
      Role: !GetAtt DynamoDBRole.Arn
      Events:
        CreateCart:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /carts
            Method: post

  GetCartFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handler/get_cart
      Handler: app.lambda_handler
      Runtime: python3.11
      Layers:
        - !Ref AuthLayer
      Role: !GetAtt DynamoDBRole.Arn
      Events:
        GetCart:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /carts/{cart_id}
            Method: get



  ClearCartFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handler/clear_cart
      Handler: app.lambda_handler
      Runtime: python3.11
      Layers:
        - !Ref AuthLayer
      Role: !GetAtt DynamoDBRole.Arn
      Events:
        ClearCart:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /carts/{cart_id}
            Method: delete

  # Order Functions
  CreateOrderFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handler/create_order
      Handler: app.lambda_handler
      Runtime: python3.11
      Layers:
        - !Ref AuthLayer
      Role: !GetAtt DynamoDBRole.Arn
      Events:
        CreateOrder:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /orders
            Method: post

  GetOrdersFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handler/get_orders
      Handler: app.lambda_handler
      Runtime: python3.11
      Layers:
        - !Ref AuthLayer
      Role: !GetAtt DynamoDBRole.Arn
      Events:
        GetOrders:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /orders
            Method: get

  GetOrderByIdFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handler/get_order_byid
      Handler: app.lambda_handler
      Runtime: python3.11
      Layers:
        - !Ref AuthLayer
      Role: !GetAtt DynamoDBRole.Arn
      Events:
        GetOrderById:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /orders/{order_id}
            Method: get

  UpdateOrderStatusFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handler/update_order_status
      Handler: app.lambda_handler
      Runtime: python3.11
      Layers:
        - !Ref AuthLayer
      Role: !GetAtt DynamoDBRole.Arn
      Events:
        UpdateOrderStatus:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /orders/{order_id}/status
            Method: put

  GetCustomerOrdersFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handler/get_customer_orders
      Handler: app.lambda_handler
      Runtime: python3.11
      Layers:
        - !Ref AuthLayer
      Role: !GetAtt DynamoDBRole.Arn
      Events:
        GetCustomerOrders:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /orders/customer/{customer_id}
            Method: get

  # Event Management Functions
  GetEventByIdFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handler/get_event_byid
      Handler: app.lambda_handler
      Runtime: python3.11
      Layers:
        - !Ref AuthLayer
      Role: !GetAtt DynamoDBRole.Arn
      Events:
        GetEventById:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /events/{event_id}
            Method: get

  UpdateEventFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handler/update_event
      Handler: app.lambda_handler
      Runtime: python3.11
      Layers:
        - !Ref AuthLayer
      Role: !GetAtt DynamoDBRole.Arn
      Events:
        UpdateEvent:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /events/{event_id}
            Method: put

  DeleteEventFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handler/delete_event
      Handler: app.lambda_handler
      Runtime: python3.11
      Layers:
        - !Ref AuthLayer
      Role: !GetAtt DynamoDBRole.Arn
      Events:
        DeleteEvent:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /events/{event_id}
            Method: delete

  UpdateCartItemsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handler/update_cart_items
      Handler: app.lambda_handler
      Runtime: python3.11
      Layers:
        - !Ref AuthLayer
      Role: !GetAtt DynamoDBRole.Arn
      Events:
        UpdateCartItems:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /carts/{cart_id}/items
            Method: put

  # Generic S3 File Manager Function
  S3FileManagerFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handler/s3_file_manager
      Handler: app.lambda_handler
      Runtime: python3.11
      Timeout: 30
      Layers:
        - !Ref AuthLayer
      Policies:
        - S3ReadPolicy:
            BucketName: my-hdcn-bucket
        - S3WritePolicy:
            BucketName: my-hdcn-bucket
        - Statement:
          - Effect: Allow
            Action:
              - s3:DeleteObject
            Resource: 
              - arn:aws:s3:::my-hdcn-bucket/*
      Events:
        UploadFile:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /s3/files
            Method: post
        DeleteFile:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /s3/files
            Method: delete
        ListFiles:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /s3/files
            Method: get

  # S3 Lifecycle Configuration for Analytics Data in existing bucket
  # Note: Using existing my-hdcn-bucket with analytics/ folder structure

  # Member Parquet Generation Function (Docker Container)
  GenerateMemberParquetFunction:
    Type: AWS::Serverless::Function
    Properties:
      PackageType: Image
      ImageUri: !Sub "${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/hdcn-parquet-generator:latest"
      Timeout: 300  # 5 minutes for processing large datasets
      MemorySize: 1024  # More memory for pandas/pyarrow processing
      Role: !GetAtt DynamoDBRole.Arn
      Environment:
        Variables:
          MEMBERS_TABLE_NAME: !Ref MembersTable
          S3_BUCKET_NAME: "my-hdcn-bucket"
          S3_PREFIX: "analytics/parquet/members/"
          PYTHONPATH: /var/task
      Events:
        GenerateParquet:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /analytics/generate-parquet
            Method: post

  # Member Export Function (Simple JSON export - much better than parquet!)
  ExportMembersFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handler/export_members
      Handler: app.lambda_handler
      Runtime: python3.11
      Layers:
        - !Ref AuthLayer
      Role: !GetAtt DynamoDBRole.Arn
      Environment:
        Variables:
          MEMBERS_TABLE_NAME: !Ref MembersTable
      Events:
        ExportMembers:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /members/export
            Method: get

  # Parquet Download Function (for Members_Read users)
  DownloadParquetFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handler/download_parquet
      Handler: app.lambda_handler
      Runtime: python3.11
      Layers:
        - !Ref AuthLayer
      Role: !GetAtt DynamoDBRole.Arn
      Environment:
        Variables:
          S3_BUCKET_NAME: "my-hdcn-bucket"
          S3_PREFIX: "analytics/parquet/members/"
      Events:
        DownloadParquet:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /analytics/download-parquet/{filename}
            Method: get

Outputs:
  ApiBaseUrl:
    Description: "API Gateway endpoint URL"
    Value: !Sub "https://${MyApi}.execute-api.${AWS::Region}.amazonaws.com/${Environment}"
  
  CognitoUserPoolId:
    Description: "Cognito User Pool ID for H-DCN Authentication"
    Value: !Ref ExistingUserPoolId
    Export:
      Name: !Sub "${AWS::StackName}-CognitoUserPoolId"
  
  CognitoUserPoolClientId:
    Description: "Cognito User Pool Client ID for H-DCN Web Application"
    Value: !Ref ExistingUserPoolClientId
    Export:
      Name: !Sub "${AWS::StackName}-CognitoUserPoolClientId"

  GenerateMemberParquetFunctionName:
    Description: "Name of the GenerateMemberParquetFunction for container updates"
    Value: !Ref GenerateMemberParquetFunction
    Export:
      Name: !Sub "${AWS::StackName}-GenerateMemberParquetFunctionName"
  
  CognitoUserPoolDomain:
    Description: "Cognito User Pool Domain for hosted UI"
    Value: "https://h-dcn-auth-new-344561557829.auth.eu-west-1.amazoncognito.com"
    Export:
      Name: !Sub "${AWS::StackName}-CognitoUserPoolDomain"

  # H-DCN Role Group Names (existing groups managed by webshop-backend stack)
  HDCNBasicMemberRole:
    Description: "Basic H-DCN member role group name (existing)"
    Value: "hdcnLeden"
    Export:
      Name: !Sub "${AWS::StackName}-HDCNLedenGroup"

  # Analytics Data Folder Structure
  AnalyticsDataInfo:
    Description: "Analytics data is stored in my-hdcn-bucket under analytics/ folder"
    Value: "s3://my-hdcn-bucket/analytics/"
    Export:
      Name: !Sub "${AWS::StackName}-AnalyticsDataPath"

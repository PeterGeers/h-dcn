AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: >
  python-crud-api-test

  Sample SAM Template for python-crud-api-test
  # Updated to remove Cognito function temporarily

Globals:
  Function:
    Timeout: 10
    MemorySize: 128
    Runtime: python3.11
    Tracing: Active
    Architectures:
      - x86_64
    Environment:
      Variables:
        DYNAMODB_TABLE: !Ref Table
        REGION_NAME: !Ref Region
  Api:
    TracingEnabled: True
    Cors:
      AllowMethods: "'OPTIONS,GET,POST,PUT,DELETE,PATCH'"
      AllowHeaders: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
      AllowOrigin: "'*'"
        
Parameters:
  Table:
    Type: String
    Default: Producten
  Region:
    Type: String
    Default: eu-west-1
  MembersTable:
    Type: String
    Default: Members
  PaymentsTable:
    Type: String
    Default: Payments
  EventsTable:
    Type: String
    Default: Events
  MembershipsTable:
    Type: String
    Default: Memberships
  CartsTable:
    Type: String
    Default: Carts
  OrdersTable:
    Type: String
    Default: Orders
  DefaultTempPassword:
    Type: String
    NoEcho: true
    Description: Default temporary password for new Cognito users
    Default: TempPass123!
  ParametersTable:
    Type: String
    Default: Parameters
  ForceUpdate:
    Type: String
    Default: "2024-01-16"
  
  # Email template customization parameters
  OrganizationName:
    Type: String
    Default: "Harley-Davidson Club Nederland"
    Description: "Organization name used in email templates"
  
  OrganizationWebsite:
    Type: String
    Default: "https://portal.h-dcn.nl"
    Description: "Organization website URL used in email templates"
  
  OrganizationEmail:
    Type: String
    Default: "webhulpje@h-dcn.nl"
    Description: "Organization contact email used in email templates"
  
  OrganizationShortName:
    Type: String
    Default: "H-DCN"
    Description: "Organization short name used in email templates"
  
  # Account recovery specific parameters
  SupportPhoneNumber:
    Type: String
    Default: "+31 (0)20 123 4567"
    Description: "Support phone number for account recovery assistance"
  
  RecoveryPageUrl:
    Type: String
    Default: "/recovery"
    Description: "Relative URL path for the account recovery page"
  
  HelpPageUrl:
    Type: String
    Default: "/help/passwordless-recovery"
    Description: "Relative URL path for the passwordless recovery help page"

Resources:
  
  # S3 Bucket for Email Templates
  EmailTemplatesBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub "${AWS::StackName}-email-templates"
      VersioningConfiguration:
        Status: Enabled
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      Tags:
        - Key: Application
          Value: H-DCN
        - Key: Purpose
          Value: EmailTemplates

  # Cognito User Pool for H-DCN Authentication (Passwordless Configuration)
  HDCNCognitoUserPool:
    Type: AWS::Cognito::UserPool
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      UserPoolName: H-DCN-Authentication-Pool
      # Configure email as username for passwordless authentication
      UsernameAttributes:
        - email
      AutoVerifiedAttributes:
        - email
      # Email configuration for verification and recovery
      EmailConfiguration:
        EmailSendingAccount: DEVELOPER
        # Custom reply-to for recovery emails
        ReplyToEmailAddress: !Ref OrganizationEmail
        # Source ARN for SES (using verified organization email)
        SourceArn: !Sub "arn:aws:ses:${AWS::Region}:${AWS::AccountId}:identity/${OrganizationEmail}"
      # Minimal password policy (passwords optional for passwordless flow)
      Policies:
        PasswordPolicy:
          MinimumLength: 8
          RequireUppercase: false
          RequireLowercase: false
          RequireNumbers: false
          RequireSymbols: false
          TemporaryPasswordValidityDays: 7
      # MFA configuration - Optional for regular users, required for admin roles
      MfaConfiguration: "OPTIONAL"
      EnabledMfas:
        - SOFTWARE_TOKEN_MFA
      # Enhanced email verification templates
      EmailVerificationMessage: |
        Welkom bij H-DCN!
        
        Uw verificatiecode is: {####}
        
        Voer deze code in om uw e-mailadres te bevestigen en toegang te krijgen tot uw H-DCN account.
        
        Deze code is 24 uur geldig.
        
        Als u dit account niet heeft aangemaakt, kunt u deze e-mail negeren.
        
        Met vriendelijke groet,
        Het H-DCN Team
        
        ---
        Harley-Davidson Club Nederland
        Website: https://h-dcn.nl
        E-mail: webhulpje@h-dcn.nl
      EmailVerificationSubject: "H-DCN Account Verificatie - Bevestig uw e-mailadres"
      
      # Comprehensive verification message template for different message types
      VerificationMessageTemplate:
        DefaultEmailOption: CONFIRM_WITH_CODE
        # Email templates handled by Lambda Custom Message trigger
      
      # Admin creation message template (for bulk user creation)
      AdminCreateUserConfig:
        AllowAdminCreateUserOnly: false
        # Email templates handled by Lambda Custom Message trigger
        UnusedAccountValidityDays: 7
      
      # Lambda triggers for custom email templates
      LambdaConfig:
        CustomMessage: !GetAtt CognitoCustomMessageFunction.Arn
        PostConfirmation: !GetAtt CognitoPostConfirmationFunction.Arn
      # Require email verification before updates
      UserAttributeUpdateSettings:
        AttributesRequireVerificationBeforeUpdate:
          - email
      # Account recovery via email (passwordless)
      AccountRecoverySetting:
        RecoveryMechanisms:
          - Name: verified_email
            Priority: 1
      
      # Enhanced account recovery message templates
      UserPoolAddOns:
        AdvancedSecurityMode: "OFF"
      # Tags for resource management
      UserPoolTags:
        Application: H-DCN
        Environment: Production
        Purpose: PasswordlessAuthentication
      
      # Custom attributes for passkey registration tracking
      Schema:
        - Name: email
          AttributeDataType: String
          Required: false
          Mutable: true
        - Name: given_name
          AttributeDataType: String
          Required: false
          Mutable: true
        - Name: family_name
          AttributeDataType: String
          Required: false
          Mutable: true
        - Name: passkey_registered
          AttributeDataType: String
          Required: false
          Mutable: true
        - Name: passkey_date
          AttributeDataType: String
          Required: false
          Mutable: true

  # Cognito User Pool Client (Passwordless Configuration)
  HDCNCognitoUserPoolClient:
    Type: AWS::Cognito::UserPoolClient
    Properties:
      UserPoolId: !Ref HDCNCognitoUserPool
      ClientName: H-DCN-Web-Client
      GenerateSecret: false
      # Configure AuthFlows for passwordless authentication
      ExplicitAuthFlows:
        - ALLOW_USER_AUTH          # Choice-based auth for passwordless authentication
        - ALLOW_REFRESH_TOKEN_AUTH  # Required for token refresh
        - ALLOW_USER_SRP_AUTH       # SRP auth for compatibility
        - ALLOW_USER_PASSWORD_AUTH  # Required for forgot password flow
      # Enable passwordless authentication options
      AuthSessionValidity: 3  # 3 minutes for auth session
      # Configure supported identity providers
      SupportedIdentityProviders:
        - COGNITO
      # Configure appropriate read attributes for H-DCN member data
      ReadAttributes:
        - email
        - email_verified
        - given_name
        - family_name
        - phone_number
        - phone_number_verified
        - preferred_username
      # Configure appropriate write attributes for member profile updates
      WriteAttributes:
        - email
        - given_name
        - family_name
        - phone_number
        - preferred_username
      # Configure token validity periods for security and user experience
      TokenValidityUnits:
        AccessToken: hours
        IdToken: hours
        RefreshToken: days
      AccessTokenValidity: 1      # 1 hour for access tokens
      IdTokenValidity: 1          # 1 hour for ID tokens  
      RefreshTokenValidity: 30    # 30 days for refresh tokens
      PreventUserExistenceErrors: ENABLED
      # Enable callback URLs for authentication flows
      CallbackURLs:
        - http://localhost:3000/auth/callback
        - https://portal.h-dcn.nl/auth/callback
      LogoutURLs:
        - http://localhost:3000/auth/logout
        - https://portal.h-dcn.nl/auth/logout

  # Cognito User Pool Domain (for hosted UI if needed)
  HDCNCognitoUserPoolDomain:
    Type: AWS::Cognito::UserPoolDomain
    Properties:
      UserPoolId: !Ref HDCNCognitoUserPool
      Domain: !Sub "h-dcn-auth-${AWS::AccountId}"

  # H-DCN User Pool Groups (Roles)
  # Basic member role
  HDCNLedenGroup:
    Type: AWS::Cognito::UserPoolGroup
    Properties:
      UserPoolId: !Ref HDCNCognitoUserPool
      GroupName: hdcnLeden
      Description: "Basic H-DCN member role - access to personal data and webshop"
      Precedence: 100

  # Member management roles
  MembersCRUDAllGroup:
    Type: AWS::Cognito::UserPoolGroup
    Properties:
      UserPoolId: !Ref HDCNCognitoUserPool
      GroupName: Members_CRUD_All
      Description: "Full member management permissions - create, read, update, delete all member data"
      Precedence: 10

  MembersReadAllGroup:
    Type: AWS::Cognito::UserPoolGroup
    Properties:
      UserPoolId: !Ref HDCNCognitoUserPool
      GroupName: Members_Read_All
      Description: "Read access to all member data"
      Precedence: 20

  MembersStatusApproveGroup:
    Type: AWS::Cognito::UserPoolGroup
    Properties:
      UserPoolId: !Ref HDCNCognitoUserPool
      GroupName: Members_Status_Approve
      Description: "Permission to approve member status changes"
      Precedence: 15

  # Event management roles
  EventsReadAllGroup:
    Type: AWS::Cognito::UserPoolGroup
    Properties:
      UserPoolId: !Ref HDCNCognitoUserPool
      GroupName: Events_Read_All
      Description: "Read access to all events"
      Precedence: 30

  EventsCRUDAllGroup:
    Type: AWS::Cognito::UserPoolGroup
    Properties:
      UserPoolId: !Ref HDCNCognitoUserPool
      GroupName: Events_CRUD_All
      Description: "Full event management permissions"
      Precedence: 25

  # Product management roles
  ProductsReadAllGroup:
    Type: AWS::Cognito::UserPoolGroup
    Properties:
      UserPoolId: !Ref HDCNCognitoUserPool
      GroupName: Products_Read_All
      Description: "Read access to all products"
      Precedence: 40

  ProductsCRUDAllGroup:
    Type: AWS::Cognito::UserPoolGroup
    Properties:
      UserPoolId: !Ref HDCNCognitoUserPool
      GroupName: Products_CRUD_All
      Description: "Full product management permissions"
      Precedence: 35

  # Communication roles
  CommunicationReadAllGroup:
    Type: AWS::Cognito::UserPoolGroup
    Properties:
      UserPoolId: !Ref HDCNCognitoUserPool
      GroupName: Communication_Read_All
      Description: "Read access to all communication data"
      Precedence: 50

  CommunicationExportAllGroup:
    Type: AWS::Cognito::UserPoolGroup
    Properties:
      UserPoolId: !Ref HDCNCognitoUserPool
      GroupName: Communication_Export_All
      Description: "Permission to export communication data and create mailing lists"
      Precedence: 45

  # System administration roles
  SystemUserManagementGroup:
    Type: AWS::Cognito::UserPoolGroup
    Properties:
      UserPoolId: !Ref HDCNCognitoUserPool
      GroupName: System_User_Management
      Description: "System user management permissions"
      Precedence: 5

  SystemLogsReadGroup:
    Type: AWS::Cognito::UserPoolGroup
    Properties:
      UserPoolId: !Ref HDCNCognitoUserPool
      GroupName: System_Logs_Read
      Description: "Permission to read system logs and audit trails"
      Precedence: 55

  # Additional communication and system roles for Webmaster
  CommunicationCRUDAllGroup:
    Type: AWS::Cognito::UserPoolGroup
    Properties:
      UserPoolId: !Ref HDCNCognitoUserPool
      GroupName: Communication_CRUD_All
      Description: "Full communication management permissions - create, read, update, delete all communication data"
      Precedence: 42

  SystemCRUDAllGroup:
    Type: AWS::Cognito::UserPoolGroup
    Properties:
      UserPoolId: !Ref HDCNCognitoUserPool
      GroupName: System_CRUD_All
      Description: "Full system administration permissions - complete system management access"
      Precedence: 3

  # Lambda function for custom Cognito email messages
  CognitoCustomMessageFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handler/cognito_custom_message
      Handler: app.lambda_handler
      Runtime: python3.11
      Role: !GetAtt CognitoLambdaRole.Arn
      Environment:
        Variables:
          ORGANIZATION_NAME: !Ref OrganizationName
          ORGANIZATION_WEBSITE: !Ref OrganizationWebsite
          ORGANIZATION_EMAIL: !Ref OrganizationEmail
          ORGANIZATION_SHORT_NAME: !Ref OrganizationShortName
          # Account recovery specific settings
          RECOVERY_URL: !Sub "${OrganizationWebsite}${RecoveryPageUrl}"
          HELP_URL: !Sub "${OrganizationWebsite}${HelpPageUrl}"
          SUPPORT_PHONE: !Ref SupportPhoneNumber
          # S3 Template Bucket
          EMAIL_TEMPLATES_BUCKET: !Ref EmailTemplatesBucket

  # Lambda function for post-confirmation actions
  CognitoPostConfirmationFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handler/cognito_post_confirmation
      Handler: app.lambda_handler
      Runtime: python3.11
      Role: !GetAtt CognitoLambdaRole.Arn
      Environment:
        Variables:
          DEFAULT_MEMBER_GROUP: hdcnLeden
          ORGANIZATION_NAME: !Ref OrganizationName
          ORGANIZATION_WEBSITE: !Ref OrganizationWebsite
          ORGANIZATION_EMAIL: !Ref OrganizationEmail
          ORGANIZATION_SHORT_NAME: !Ref OrganizationShortName

  # IAM Role for Cognito Lambda triggers
  CognitoLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        - arn:aws:iam::aws:policy/AWSXRayDaemonWriteAccess
      Policies:
        - PolicyName: CognitoLambdaAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - cognito-idp:AdminAddUserToGroup
                  - cognito-idp:AdminGetUser
                  - cognito-idp:ListUsers
                Resource: 
                  - !Sub "arn:aws:cognito-idp:${AWS::Region}:${AWS::AccountId}:userpool/*"
        - PolicyName: S3EmailTemplatesAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                Resource: 
                  - !Sub "${EmailTemplatesBucket.Arn}/*"
              - Effect: Allow
                Action:
                  - s3:ListBucket
                Resource: 
                  - !GetAtt EmailTemplatesBucket.Arn

  # Lambda permissions for Cognito triggers
  CognitoCustomMessagePermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !GetAtt CognitoCustomMessageFunction.Arn
      Action: lambda:InvokeFunction
      Principal: cognito-idp.amazonaws.com
      SourceArn: !Sub "arn:aws:cognito-idp:${AWS::Region}:${AWS::AccountId}:userpool/${HDCNCognitoUserPool}"

  CognitoPostConfirmationPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !GetAtt CognitoPostConfirmationFunction.Arn
      Action: lambda:InvokeFunction
      Principal: cognito-idp.amazonaws.com
      SourceArn: !Sub "arn:aws:cognito-idp:${AWS::Region}:${AWS::AccountId}:userpool/${HDCNCognitoUserPool}"
  MyApi:
    Type: AWS::Serverless::Api
    Properties:
      StageName: prod
      Cors:
        AllowMethods: "'OPTIONS,GET,POST,PUT,DELETE,PATCH'"
        AllowHeaders: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
        AllowOrigin: "'*'"

  # IAM Role for DynamoDB access (updated for GSI)
  DynamoDBRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        - arn:aws:iam::aws:policy/AWSXRayDaemonWriteAccess
      Policies:
        - PolicyName: DynamoDBAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:GetItem
                  - dynamodb:PutItem
                  - dynamodb:UpdateItem
                  - dynamodb:DeleteItem
                  - dynamodb:Scan
                  - dynamodb:Query
                Resource:
                  - !Sub "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${Table}"
                  - !Sub "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${MembersTable}"
                  - !Sub "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${PaymentsTable}"
                  - !Sub "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${EventsTable}"
                  - !Sub "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${MembershipsTable}"
                  - !Sub "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${CartsTable}"
                  - !Sub "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${OrdersTable}"
                  - !Sub "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${ParametersTable}"
                  - !Sub "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${ParametersTable}/index/*"
                  - !Sub "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${PaymentsTable}/index/*"
                  - !Sub "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${OrdersTable}/index/*"
                  - !Sub "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${CartsTable}/index/*"
                  - !Sub "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${MembersTable}/index/*"
                  - !Sub "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${EventsTable}/index/*"
                  - !Sub "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${MembershipsTable}/index/*"

  # IAM Role for Cognito Admin access
  CognitoAdminRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        - arn:aws:iam::aws:policy/AWSXRayDaemonWriteAccess
      Policies:
        - PolicyName: CognitoAdminAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - cognito-idp:ListUsers
                  - cognito-idp:AdminCreateUser
                  - cognito-idp:AdminDeleteUser
                  - cognito-idp:AdminGetUser
                  - cognito-idp:AdminUpdateUserAttributes
                  - cognito-idp:AdminAddUserToGroup
                  - cognito-idp:AdminRemoveUserFromGroup
                  - cognito-idp:AdminListGroupsForUser
                  - cognito-idp:ListGroups
                  - cognito-idp:CreateGroup
                  - cognito-idp:DeleteGroup
                  - cognito-idp:ListUsersInGroup
                  - cognito-idp:DescribeUserPool
                  - cognito-idp:AdminSetUserPassword
                  - cognito-idp:AdminInitiateAuth
                  - cognito-idp:AdminRespondToAuthChallenge
                  - cognito-idp:GetGroup
                  - cognito-idp:UpdateGroup
                Resource: 
                  - !Sub "arn:aws:cognito-idp:${AWS::Region}:${AWS::AccountId}:userpool/${HDCNCognitoUserPool}"
                  - !Sub "arn:aws:cognito-idp:${AWS::Region}:${AWS::AccountId}:userpool/${HDCNCognitoUserPool}/*"

  InsertProductFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handler/insert_product
      Handler: app.lambda_handler
      Runtime: python3.11
      Role: !GetAtt DynamoDBRole.Arn
      Events:
        InsertProduct:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /insert-product/
            Method: post
            
  DeleteProductFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handler/delete_product
      Handler: app.lambda_handler
      Runtime: python3.11
      Role: !GetAtt DynamoDBRole.Arn
      Events:
        DeletePost:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /delete-product/{id}
            Method: delete

  GetProductByIdFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handler/get_product_byid
      Handler: app.lambda_handler
      Runtime: python3.11
      Role: !GetAtt DynamoDBRole.Arn
      Events:
        GetPost:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /getproduct-byid/{id}
            Method: get

  scanProductFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handler/scan_product
      Handler: app.lambda_handler
      Runtime: python3.11
      Role: !GetAtt DynamoDBRole.Arn
      Events:
        ListProducts:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /scan-product/
            Method: get

  UpdateProductFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handler/update_product
      Handler: app.lambda_handler
      Runtime: python3.11
      Role: !GetAtt DynamoDBRole.Arn
      Events:
        UpdatePost:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /update-product/{id}
            Method: put

  # Member Management Functions
  CreateMemberFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handler/create_member
      Handler: app.lambda_handler
      Runtime: python3.11
      Role: !GetAtt DynamoDBRole.Arn
      Events:
        CreateMember:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /members
            Method: post

  GetMembersFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handler/get_members
      Handler: app.lambda_handler
      Runtime: python3.11
      Role: !GetAtt DynamoDBRole.Arn
      Events:
        GetMembers:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /members
            Method: get

  GetMemberByIdFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handler/get_member_byid
      Handler: app.lambda_handler
      Runtime: python3.11
      Role: !GetAtt DynamoDBRole.Arn
      Events:
        GetMemberById:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /members/{id}
            Method: get

  UpdateMemberFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handler/update_member
      Handler: app.lambda_handler
      Runtime: python3.11
      Role: !GetAtt DynamoDBRole.Arn
      Events:
        UpdateMember:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /members/{id}
            Method: put

  DeleteMemberFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handler/delete_member
      Handler: app.lambda_handler
      Runtime: python3.11
      Role: !GetAtt DynamoDBRole.Arn
      Events:
        DeleteMember:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /members/{id}
            Method: delete

  # Payment Functions
  CreatePaymentFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handler/create_payment
      Handler: app.lambda_handler
      Runtime: python3.11
      Role: !GetAtt DynamoDBRole.Arn
      Events:
        CreatePayment:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /payments
            Method: post

  GetPaymentsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handler/get_payments
      Handler: app.lambda_handler
      Runtime: python3.11
      Role: !GetAtt DynamoDBRole.Arn
      Events:
        GetPayments:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /payments
            Method: get

  GetPaymentByIdFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handler/get_payment_byid
      Handler: app.lambda_handler
      Runtime: python3.11
      Role: !GetAtt DynamoDBRole.Arn
      Events:
        GetPaymentById:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /payments/{payment_id}
            Method: get

  UpdatePaymentFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handler/update_payment
      Handler: app.lambda_handler
      Runtime: python3.11
      Role: !GetAtt DynamoDBRole.Arn
      Events:
        UpdatePayment:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /payments/{payment_id}
            Method: put

  DeletePaymentFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handler/delete_payment
      Handler: app.lambda_handler
      Runtime: python3.11
      Role: !GetAtt DynamoDBRole.Arn
      Events:
        DeletePayment:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /payments/{payment_id}
            Method: delete

  GetMemberPaymentsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handler/get_member_payments
      Handler: app.lambda_handler
      Runtime: python3.11
      Role: !GetAtt DynamoDBRole.Arn
      Events:
        GetMemberPayments:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /payments/member/{member_id}
            Method: get

  # Event Functions
  CreateEventFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handler/create_event
      Handler: app.lambda_handler
      Runtime: python3.11
      Role: !GetAtt DynamoDBRole.Arn
      Events:
        CreateEvent:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /events
            Method: post

  GetEventsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handler/get_events
      Handler: app.lambda_handler
      Runtime: python3.11
      Role: !GetAtt DynamoDBRole.Arn
      Events:
        GetEvents:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /events
            Method: get

  # Cognito Admin Function
  HdcnCognitoAdminFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handler/hdcn_cognito_admin
      Handler: app.lambda_handler
      Runtime: python3.11
      Role: !GetAtt CognitoAdminRole.Arn
      Environment:
        Variables:
          DEFAULT_TEMP_PASSWORD: !Ref DefaultTempPassword
          COGNITO_USER_POOL_ID: !Ref HDCNCognitoUserPool
          COGNITO_USER_POOL_CLIENT_ID: !Ref HDCNCognitoUserPoolClient
          WEBAUTHN_RP_ID: "portal.h-dcn.nl"
      Events:
        CognitoRoot:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /cognito
            Method: ANY
        CognitoProxy:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /cognito/{proxy+}
            Method: ANY
        AuthRoot:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /auth
            Method: ANY
        AuthProxy:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /auth/{proxy+}
            Method: ANY

  # Membership Type Functions
  GetMembershipsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handler/get_memberships
      Handler: app.lambda_handler
      Runtime: python3.11
      Role: !GetAtt DynamoDBRole.Arn
      Events:
        GetMemberships:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /memberships
            Method: get

  CreateMembershipFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handler/create_membership
      Handler: app.lambda_handler
      Runtime: python3.11
      Role: !GetAtt DynamoDBRole.Arn
      Events:
        CreateMembership:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /memberships
            Method: post

  GetMembershipByIdFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handler/get_membership_byid
      Handler: app.lambda_handler
      Runtime: python3.11
      Role: !GetAtt DynamoDBRole.Arn
      Events:
        GetMembershipById:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /memberships/{id}
            Method: get

  UpdateMembershipFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handler/update_membership
      Handler: app.lambda_handler
      Runtime: python3.11
      Role: !GetAtt DynamoDBRole.Arn
      Events:
        UpdateMembership:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /memberships/{id}
            Method: put

  DeleteMembershipFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handler/delete_membership
      Handler: app.lambda_handler
      Runtime: python3.11
      Role: !GetAtt DynamoDBRole.Arn
      Events:
        DeleteMembership:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /memberships/{id}
            Method: delete

  # Cart Functions
  CreateCartFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handler/create_cart
      Handler: app.lambda_handler
      Runtime: python3.11
      Role: !GetAtt DynamoDBRole.Arn
      Events:
        CreateCart:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /carts
            Method: post

  GetCartFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handler/get_cart
      Handler: app.lambda_handler
      Runtime: python3.11
      Role: !GetAtt DynamoDBRole.Arn
      Events:
        GetCart:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /carts/{cart_id}
            Method: get



  ClearCartFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handler/clear_cart
      Handler: app.lambda_handler
      Runtime: python3.11
      Role: !GetAtt DynamoDBRole.Arn
      Events:
        ClearCart:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /carts/{cart_id}
            Method: delete

  # Order Functions
  CreateOrderFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handler/create_order
      Handler: app.lambda_handler
      Runtime: python3.11
      Role: !GetAtt DynamoDBRole.Arn
      Events:
        CreateOrder:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /orders
            Method: post

  GetOrdersFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handler/get_orders
      Handler: app.lambda_handler
      Runtime: python3.11
      Role: !GetAtt DynamoDBRole.Arn
      Events:
        GetOrders:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /orders
            Method: get

  GetOrderByIdFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handler/get_order_byid
      Handler: app.lambda_handler
      Runtime: python3.11
      Role: !GetAtt DynamoDBRole.Arn
      Events:
        GetOrderById:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /orders/{order_id}
            Method: get

  UpdateOrderStatusFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handler/update_order_status
      Handler: app.lambda_handler
      Runtime: python3.11
      Role: !GetAtt DynamoDBRole.Arn
      Events:
        UpdateOrderStatus:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /orders/{order_id}/status
            Method: put

  GetCustomerOrdersFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handler/get_customer_orders
      Handler: app.lambda_handler
      Runtime: python3.11
      Role: !GetAtt DynamoDBRole.Arn
      Events:
        GetCustomerOrders:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /orders/customer/{customer_id}
            Method: get

  # Event Management Functions
  GetEventByIdFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handler/get_event_byid
      Handler: app.lambda_handler
      Runtime: python3.11
      Role: !GetAtt DynamoDBRole.Arn
      Events:
        GetEventById:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /events/{event_id}
            Method: get

  UpdateEventFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handler/update_event
      Handler: app.lambda_handler
      Runtime: python3.11
      Role: !GetAtt DynamoDBRole.Arn
      Events:
        UpdateEvent:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /events/{event_id}
            Method: put

  DeleteEventFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handler/delete_event
      Handler: app.lambda_handler
      Runtime: python3.11
      Role: !GetAtt DynamoDBRole.Arn
      Events:
        DeleteEvent:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /events/{event_id}
            Method: delete

  # Parameter Functions
  CreateParameterFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handler/create_parameter
      Handler: app.lambda_handler
      Runtime: python3.11
      Role: !GetAtt DynamoDBRole.Arn
      Events:
        CreateParameter:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /parameters
            Method: post

  GetParametersFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handler/get_parameters
      Handler: app.lambda_handler
      Runtime: python3.11
      Role: !GetAtt DynamoDBRole.Arn
      Events:
        GetParameters:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /parameters
            Method: get

  GetParameterByIdFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handler/get_parameter_byid
      Handler: app.lambda_handler
      Runtime: python3.11
      Role: !GetAtt DynamoDBRole.Arn
      Events:
        GetParameterById:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /parameters/{id}
            Method: get

  UpdateParameterFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handler/update_parameter
      Handler: app.lambda_handler
      Runtime: python3.11
      Role: !GetAtt DynamoDBRole.Arn
      Events:
        UpdateParameter:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /parameters/{id}
            Method: put

  DeleteParameterFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handler/delete_parameter
      Handler: app.lambda_handler
      Runtime: python3.11
      Role: !GetAtt DynamoDBRole.Arn
      Events:
        DeleteParameter:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /parameters/{id}
            Method: delete

  GetParameterByNameFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handler/get_parameter_byname
      Handler: app.lambda_handler
      Runtime: python3.11
      Role: !GetAtt DynamoDBRole.Arn
      Events:
        GetParameterByName:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /parameters/name/{name}
            Method: get

  UpdateCartItemsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: handler/update_cart_items
      Handler: app.lambda_handler
      Runtime: python3.11
      Role: !GetAtt DynamoDBRole.Arn
      Events:
        UpdateCartItems:
          Type: Api
          Properties:
            RestApiId: !Ref MyApi
            Path: /carts/{cart_id}/items
            Method: put

Outputs:
  ApiBaseUrl:
    Description: "API Gateway endpoint URL for Prod stage"
    Value: !Sub "https://${MyApi}.execute-api.${AWS::Region}.amazonaws.com/prod"
  
  CognitoUserPoolId:
    Description: "Cognito User Pool ID for H-DCN Authentication"
    Value: !Ref HDCNCognitoUserPool
    Export:
      Name: !Sub "${AWS::StackName}-CognitoUserPoolId"
  
  CognitoUserPoolClientId:
    Description: "Cognito User Pool Client ID for H-DCN Web Application"
    Value: !Ref HDCNCognitoUserPoolClient
    Export:
      Name: !Sub "${AWS::StackName}-CognitoUserPoolClientId"
  
  CognitoUserPoolDomain:
    Description: "Cognito User Pool Domain for hosted UI"
    Value: !Sub "https://${HDCNCognitoUserPoolDomain}.auth.${AWS::Region}.amazoncognito.com"
    Export:
      Name: !Sub "${AWS::StackName}-CognitoUserPoolDomain"

  # H-DCN Role Group Names (for application configuration)
  HDCNBasicMemberRole:
    Description: "Basic H-DCN member role group name"
    Value: !Ref HDCNLedenGroup
    Export:
      Name: !Sub "${AWS::StackName}-HDCNLedenGroup"

  HDCNAdminRoles:
    Description: "List of administrative role group names"
    Value: !Sub "${MembersCRUDAllGroup},${SystemUserManagementGroup},${EventsCRUDAllGroup},${ProductsCRUDAllGroup}"
    Export:
      Name: !Sub "${AWS::StackName}-HDCNAdminRoles"
<!DOCTYPE html>
<html>
<head>
    <title>Debug Frontend Auth</title>
</head>
<body>
    <h1>Debug Frontend Authentication</h1>
    <button onclick="debugAuth()">Debug Authentication</button>
    <button onclick="testUpload()">Test Upload</button>
    <div id="result"></div>

    <script>
        function debugAuth() {
            console.log('=== DEBUGGING AUTHENTICATION ===');
            
            // Check localStorage
            const storedUser = localStorage.getItem('hdcn_auth_user');
            console.log('üîç Raw stored user:', storedUser);
            
            if (storedUser) {
                try {
                    const user = JSON.parse(storedUser);
                    console.log('üîç Parsed user object:', user);
                    console.log('üîç User structure keys:', Object.keys(user));
                    
                    if (user.signInUserSession) {
                        console.log('üîç signInUserSession keys:', Object.keys(user.signInUserSession));
                        
                        if (user.signInUserSession.accessToken) {
                            console.log('üîç accessToken keys:', Object.keys(user.signInUserSession.accessToken));
                            
                            if (user.signInUserSession.accessToken.payload) {
                                console.log('üîç payload keys:', Object.keys(user.signInUserSession.accessToken.payload));
                                console.log('üîç cognito:groups:', user.signInUserSession.accessToken.payload['cognito:groups']);
                            }
                        }
                    }
                    
                    // Try to extract groups
                    const groups = user.signInUserSession?.accessToken?.payload?.['cognito:groups'];
                    console.log('üîç Extracted groups:', groups);
                    console.log('üîç Groups type:', typeof groups);
                    console.log('üîç Is array:', Array.isArray(groups));
                    
                    if (groups && Array.isArray(groups)) {
                        const enhancedGroups = groups.join(',');
                        console.log('‚úÖ Enhanced groups string:', enhancedGroups);
                        
                        document.getElementById('result').innerHTML = `
                            <h3>Authentication Debug Results:</h3>
                            <p><strong>Groups found:</strong> ${enhancedGroups}</p>
                            <p><strong>Groups array:</strong> ${JSON.stringify(groups)}</p>
                            <p><strong>User has data:</strong> Yes</p>
                        `;
                    } else {
                        console.log('‚ùå No valid groups found');
                        document.getElementById('result').innerHTML = `
                            <h3>Authentication Debug Results:</h3>
                            <p><strong>Error:</strong> No valid groups found</p>
                            <p><strong>Groups value:</strong> ${JSON.stringify(groups)}</p>
                            <p><strong>User has data:</strong> ${storedUser ? 'Yes' : 'No'}</p>
                        `;
                    }
                } catch (error) {
                    console.error('‚ùå Error parsing stored user:', error);
                    document.getElementById('result').innerHTML = `
                        <h3>Authentication Debug Results:</h3>
                        <p><strong>Error:</strong> Failed to parse stored user data</p>
                        <p><strong>Error message:</strong> ${error.message}</p>
                    `;
                }
            } else {
                console.log('‚ùå No stored user found');
                document.getElementById('result').innerHTML = `
                    <h3>Authentication Debug Results:</h3>
                    <p><strong>Error:</strong> No stored user found in localStorage</p>
                    <p><strong>Fallback groups:</strong> hdcnAdmins,System_CRUD_All</p>
                `;
            }
        }
        
        function testUpload() {
            console.log('=== TESTING UPLOAD ===');
            
            // Get enhanced groups using the same logic as the frontend
            const storedUser = localStorage.getItem('hdcn_auth_user');
            let enhancedGroups = 'hdcnAdmins,System_CRUD_All'; // fallback
            
            if (storedUser) {
                const user = JSON.parse(storedUser);
                const groups = user.signInUserSession?.accessToken?.payload?.['cognito:groups'];
                if (groups && Array.isArray(groups)) {
                    enhancedGroups = groups.join(',');
                    console.log('üîç Using real groups:', enhancedGroups);
                } else {
                    console.log('‚ö†Ô∏è Using fallback groups:', enhancedGroups);
                }
            } else {
                console.log('‚ö†Ô∏è No stored user, using fallback groups:', enhancedGroups);
            }
            
            // Test the API call
            const apiUrl = 'https://i3if973sp5.execute-api.eu-west-1.amazonaws.com/prod/s3/files';
            
            console.log('üöÄ Making API call with groups:', enhancedGroups);
            
            fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Enhanced-Groups': enhancedGroups
                },
                body: JSON.stringify({
                    bucketName: 'my-hdcn-bucket',
                    fileKey: 'debug-test-' + Date.now() + '.txt',
                    fileData: 'Debug test from frontend at ' + new Date().toISOString(),
                    contentType: 'text/plain'
                })
            })
            .then(response => {
                console.log('üì° Response status:', response.status);
                console.log('üì° Response ok:', response.ok);
                return response.json();
            })
            .then(data => {
                console.log('‚úÖ Response data:', data);
                document.getElementById('result').innerHTML += `
                    <h3>Upload Test Results:</h3>
                    <p><strong>Status:</strong> Success</p>
                    <p><strong>Groups sent:</strong> ${enhancedGroups}</p>
                    <p><strong>Response:</strong> ${JSON.stringify(data, null, 2)}</p>
                `;
            })
            .catch(error => {
                console.error('‚ùå Upload error:', error);
                document.getElementById('result').innerHTML += `
                    <h3>Upload Test Results:</h3>
                    <p><strong>Status:</strong> Error</p>
                    <p><strong>Groups sent:</strong> ${enhancedGroups}</p>
                    <p><strong>Error:</strong> ${error.message}</p>
                `;
            });
        }
    </script>
</body>
</html>
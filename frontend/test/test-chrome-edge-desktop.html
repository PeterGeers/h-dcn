<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chrome/Edge Desktop WebAuthn Support Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: #ffffff;
        }
        .test-section {
            background: #2d2d2d;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid #ff6b35;
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
        }
        .pass { background: #1a4d3a; border-left: 4px solid #28a745; }
        .fail { background: #4d1a1a; border-left: 4px solid #dc3545; }
        .warning { background: #4d3a1a; border-left: 4px solid #ffc107; }
        .info { background: #1a3a4d; border-left: 4px solid #17a2b8; }
        button {
            background: #ff6b35;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover { background: #e55a2b; }
        button:disabled { background: #666; cursor: not-allowed; }
        .browser-info {
            background: #333;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .compatibility-matrix {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        .compatibility-matrix th,
        .compatibility-matrix td {
            border: 1px solid #555;
            padding: 8px 12px;
            text-align: left;
        }
        .compatibility-matrix th {
            background: #444;
            font-weight: bold;
        }
        .support-full { color: #28a745; font-weight: bold; }
        .support-partial { color: #ffc107; font-weight: bold; }
        .support-none { color: #dc3545; font-weight: bold; }
        pre {
            background: #222;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>üîç Chrome/Edge Desktop WebAuthn Support Test</h1>
    <p>This test specifically validates WebAuthn/Passkey support on Chrome and Edge desktop browsers.</p>

    <div class="test-section">
        <h2>Browser Detection</h2>
        <div id="browser-info" class="browser-info">
            <p>Detecting browser...</p>
        </div>
        <button onclick="detectBrowser()">Refresh Browser Detection</button>
    </div>

    <div class="test-section">
        <h2>WebAuthn API Tests</h2>
        <div id="webauthn-results"></div>
        <button onclick="runWebAuthnTests()">Run WebAuthn Tests</button>
        <button onclick="testPasskeyRegistration()">Test Passkey Registration</button>
        <button onclick="testPasskeyAuthentication()">Test Passkey Authentication</button>
    </div>

    <div class="test-section">
        <h2>Platform Authenticator Tests</h2>
        <div id="platform-results"></div>
        <button onclick="testPlatformAuthenticator()">Test Platform Authenticator</button>
        <button onclick="testWindowsHello()">Test Windows Hello (Windows only)</button>
    </div>

    <div class="test-section">
        <h2>Chrome/Edge Specific Features</h2>
        <div id="browser-specific-results"></div>
        <button onclick="testBrowserSpecificFeatures()">Test Browser-Specific Features</button>
    </div>

    <div class="test-section">
        <h2>Compatibility Matrix</h2>
        <table class="compatibility-matrix">
            <thead>
                <tr>
                    <th>Feature</th>
                    <th>Chrome 67+</th>
                    <th>Edge 18+</th>
                    <th>Current Browser</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody id="compatibility-matrix">
                <!-- Will be populated by JavaScript -->
            </tbody>
        </table>
    </div>

    <div class="test-section">
        <h2>Test Results Summary</h2>
        <div id="test-summary"></div>
        <button onclick="generateReport()">Generate Compatibility Report</button>
        <button onclick="clearResults()">Clear All Results</button>
    </div>

    <script>
        let testResults = [];
        let browserInfo = {};

        function logResult(testName, success, message, details = null) {
            const result = {
                testName,
                success,
                message,
                details,
                timestamp: new Date().toISOString()
            };
            testResults.push(result);
            
            const className = success === true ? 'pass' : success === false ? 'fail' : success === 'warning' ? 'warning' : 'info';
            const icon = success === true ? '‚úÖ' : success === false ? '‚ùå' : success === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            
            console.log(`${icon} ${testName}: ${message}`, details);
            return result;
        }

        function displayResult(containerId, result) {
            const container = document.getElementById(containerId);
            const className = result.success === true ? 'pass' : result.success === false ? 'fail' : result.success === 'warning' ? 'warning' : 'info';
            const icon = result.success === true ? '‚úÖ' : result.success === false ? '‚ùå' : result.success === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            
            const div = document.createElement('div');
            div.className = `test-result ${className}`;
            div.innerHTML = `
                <strong>${icon} ${result.testName}</strong><br>
                ${result.message}
                ${result.details ? `<pre>${JSON.stringify(result.details, null, 2)}</pre>` : ''}
                <small>Time: ${new Date(result.timestamp).toLocaleTimeString()}</small>
            `;
            container.appendChild(div);
        }

        function detectBrowser() {
            const userAgent = navigator.userAgent;
            
            // Detect browser and version
            let browserName = 'Unknown';
            let browserVersion = 'Unknown';
            let isSupported = false;
            
            if (userAgent.includes('Chrome') && !userAgent.includes('Edg')) {
                browserName = 'Chrome';
                const match = userAgent.match(/Chrome\/(\d+)/);
                browserVersion = match ? match[1] : 'Unknown';
                isSupported = parseInt(browserVersion) >= 67;
            } else if (userAgent.includes('Edg')) {
                browserName = 'Edge';
                const match = userAgent.match(/Edg\/(\d+)/);
                browserVersion = match ? match[1] : 'Unknown';
                isSupported = parseInt(browserVersion) >= 18;
            }

            // Detect platform
            let platform = 'Unknown';
            if (userAgent.includes('Windows')) platform = 'Windows';
            else if (userAgent.includes('Mac')) platform = 'macOS';
            else if (userAgent.includes('Linux')) platform = 'Linux';

            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(userAgent);
            const isDesktop = !isMobile;

            browserInfo = {
                browserName,
                browserVersion,
                platform,
                isMobile,
                isDesktop,
                isSupported,
                userAgent
            };

            const infoDiv = document.getElementById('browser-info');
            infoDiv.innerHTML = `
                <p><strong>Browser:</strong> ${browserName} ${browserVersion}</p>
                <p><strong>Platform:</strong> ${platform} ${isDesktop ? '(Desktop)' : '(Mobile)'}</p>
                <p><strong>Supported:</strong> <span class="${isSupported ? 'support-full' : 'support-none'}">${isSupported ? 'Yes' : 'No'}</span></p>
                <p><strong>User Agent:</strong> <code>${userAgent}</code></p>
            `;

            const result = logResult(
                'Browser Detection',
                isSupported,
                `Detected ${browserName} ${browserVersion} on ${platform}`,
                browserInfo
            );

            if (!isSupported) {
                logResult(
                    'Browser Compatibility Warning',
                    'warning',
                    'This browser may not fully support WebAuthn. Please use Chrome 67+ or Edge 18+ for best results.'
                );
            }
        }

        async function runWebAuthnTests() {
            const container = document.getElementById('webauthn-results');
            container.innerHTML = '';

            // Test 1: WebAuthn API availability
            const webAuthnSupported = !!(
                window.PublicKeyCredential &&
                navigator.credentials &&
                navigator.credentials.create &&
                navigator.credentials.get
            );

            const result1 = logResult(
                'WebAuthn API Support',
                webAuthnSupported,
                webAuthnSupported ? 'WebAuthn API is available' : 'WebAuthn API is not available',
                { 
                    PublicKeyCredential: !!window.PublicKeyCredential,
                    navigatorCredentials: !!navigator.credentials,
                    credentialsCreate: !!(navigator.credentials && navigator.credentials.create),
                    credentialsGet: !!(navigator.credentials && navigator.credentials.get)
                }
            );
            displayResult('webauthn-results', result1);

            if (!webAuthnSupported) {
                const result2 = logResult(
                    'WebAuthn Not Supported',
                    false,
                    'Cannot proceed with WebAuthn tests - API not available'
                );
                displayResult('webauthn-results', result2);
                return;
            }

            // Test 2: Secure context check
            const isSecureContext = window.isSecureContext;
            const result2 = logResult(
                'Secure Context (HTTPS)',
                isSecureContext,
                isSecureContext ? 'Running in secure context' : 'Not in secure context - WebAuthn requires HTTPS',
                { isSecureContext, protocol: window.location.protocol }
            );
            displayResult('webauthn-results', result2);

            // Test 3: PublicKeyCredential methods
            const hasIsUserVerifyingPlatformAuthenticatorAvailable = !!(
                window.PublicKeyCredential && 
                PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable
            );
            
            const result3 = logResult(
                'Platform Authenticator Detection Method',
                hasIsUserVerifyingPlatformAuthenticatorAvailable,
                hasIsUserVerifyingPlatformAuthenticatorAvailable ? 
                    'isUserVerifyingPlatformAuthenticatorAvailable method is available' : 
                    'isUserVerifyingPlatformAuthenticatorAvailable method is not available',
                { hasMethod: hasIsUserVerifyingPlatformAuthenticatorAvailable }
            );
            displayResult('webauthn-results', result3);
        }

        async function testPlatformAuthenticator() {
            const container = document.getElementById('platform-results');
            container.innerHTML = '';

            if (!window.PublicKeyCredential) {
                const result = logResult(
                    'Platform Authenticator Test',
                    false,
                    'WebAuthn not supported - cannot test platform authenticator'
                );
                displayResult('platform-results', result);
                return;
            }

            try {
                const available = await PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable();
                const result = logResult(
                    'Platform Authenticator Availability',
                    available,
                    available ? 
                        'Platform authenticator is available (biometrics/Windows Hello/Touch ID)' : 
                        'Platform authenticator is not available',
                    { available }
                );
                displayResult('platform-results', result);

                // Additional platform-specific checks
                if (browserInfo.platform === 'Windows') {
                    const result2 = logResult(
                        'Windows Hello Support',
                        available,
                        available ? 
                            'Windows Hello should be available for authentication' : 
                            'Windows Hello may not be set up or available',
                        { platform: 'Windows', available }
                    );
                    displayResult('platform-results', result2);
                } else if (browserInfo.platform === 'macOS') {
                    const result2 = logResult(
                        'Touch ID Support',
                        available,
                        available ? 
                            'Touch ID should be available for authentication' : 
                            'Touch ID may not be set up or available',
                        { platform: 'macOS', available }
                    );
                    displayResult('platform-results', result2);
                }

            } catch (error) {
                const result = logResult(
                    'Platform Authenticator Test Error',
                    false,
                    `Error testing platform authenticator: ${error.message}`,
                    { error: error.name, message: error.message }
                );
                displayResult('platform-results', result);
            }
        }

        async function testWindowsHello() {
            const container = document.getElementById('platform-results');
            
            if (browserInfo.platform !== 'Windows') {
                const result = logResult(
                    'Windows Hello Test',
                    'info',
                    'Windows Hello test skipped - not running on Windows',
                    { platform: browserInfo.platform }
                );
                displayResult('platform-results', result);
                return;
            }

            try {
                const available = await PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable();
                
                if (available) {
                    const result = logResult(
                        'Windows Hello Compatibility',
                        true,
                        'Windows Hello appears to be available and should work with WebAuthn',
                        { platform: 'Windows', available: true }
                    );
                    displayResult('platform-results', result);
                } else {
                    const result = logResult(
                        'Windows Hello Setup',
                        'warning',
                        'Windows Hello may not be set up. Please check Windows Settings > Accounts > Sign-in options',
                        { platform: 'Windows', available: false }
                    );
                    displayResult('platform-results', result);
                }
            } catch (error) {
                const result = logResult(
                    'Windows Hello Test Error',
                    false,
                    `Error testing Windows Hello: ${error.message}`,
                    { error: error.name, message: error.message }
                );
                displayResult('platform-results', result);
            }
        }

        async function testBrowserSpecificFeatures() {
            const container = document.getElementById('browser-specific-results');
            container.innerHTML = '';

            // Test Chrome/Edge specific features
            if (browserInfo.browserName === 'Chrome') {
                // Test Chrome-specific WebAuthn features
                const result1 = logResult(
                    'Chrome WebAuthn Support',
                    parseInt(browserInfo.browserVersion) >= 67,
                    parseInt(browserInfo.browserVersion) >= 67 ? 
                        `Chrome ${browserInfo.browserVersion} has full WebAuthn support` :
                        `Chrome ${browserInfo.browserVersion} has limited WebAuthn support (need 67+)`,
                    { version: browserInfo.browserVersion, required: 67 }
                );
                displayResult('browser-specific-results', result1);

                // Test for Chrome's conditional UI support (if available)
                if (window.PublicKeyCredential && PublicKeyCredential.isConditionalMediationAvailable) {
                    try {
                        const conditionalUI = await PublicKeyCredential.isConditionalMediationAvailable();
                        const result2 = logResult(
                            'Chrome Conditional UI Support',
                            conditionalUI,
                            conditionalUI ? 
                                'Chrome supports conditional UI for passkeys' :
                                'Chrome does not support conditional UI for passkeys',
                            { conditionalUI }
                        );
                        displayResult('browser-specific-results', result2);
                    } catch (error) {
                        const result2 = logResult(
                            'Chrome Conditional UI Test Error',
                            'warning',
                            `Could not test conditional UI: ${error.message}`,
                            { error: error.name }
                        );
                        displayResult('browser-specific-results', result2);
                    }
                }

            } else if (browserInfo.browserName === 'Edge') {
                // Test Edge-specific WebAuthn features
                const result1 = logResult(
                    'Edge WebAuthn Support',
                    parseInt(browserInfo.browserVersion) >= 18,
                    parseInt(browserInfo.browserVersion) >= 18 ? 
                        `Edge ${browserInfo.browserVersion} has full WebAuthn support` :
                        `Edge ${browserInfo.browserVersion} has limited WebAuthn support (need 18+)`,
                    { version: browserInfo.browserVersion, required: 18 }
                );
                displayResult('browser-specific-results', result1);

                // Test Windows Hello integration
                if (browserInfo.platform === 'Windows') {
                    const result2 = logResult(
                        'Edge Windows Hello Integration',
                        true,
                        'Edge has excellent Windows Hello integration',
                        { browser: 'Edge', platform: 'Windows' }
                    );
                    displayResult('browser-specific-results', result2);
                }

            } else {
                const result = logResult(
                    'Browser Compatibility Warning',
                    'warning',
                    `${browserInfo.browserName} is not Chrome or Edge. For best WebAuthn support, use Chrome 67+ or Edge 18+`,
                    { currentBrowser: browserInfo.browserName }
                );
                displayResult('browser-specific-results', result);
            }
        }

        async function testPasskeyRegistration() {
            const container = document.getElementById('webauthn-results');
            
            if (!window.PublicKeyCredential) {
                const result = logResult(
                    'Passkey Registration Test',
                    false,
                    'WebAuthn not supported - cannot test passkey registration'
                );
                displayResult('webauthn-results', result);
                return;
            }

            try {
                // Create mock registration options
                const challenge = new Uint8Array(32);
                crypto.getRandomValues(challenge);
                
                const userId = new TextEncoder().encode('test@example.com');
                
                const publicKeyCredentialCreationOptions = {
                    challenge: challenge,
                    rp: {
                        name: "H-DCN Test",
                        id: window.location.hostname,
                    },
                    user: {
                        id: userId,
                        name: "test@example.com",
                        displayName: "Test User",
                    },
                    pubKeyCredParams: [
                        { alg: -7, type: "public-key" },
                        { alg: -257, type: "public-key" }
                    ],
                    authenticatorSelection: {
                        authenticatorAttachment: "platform",
                        userVerification: "preferred"
                    },
                    timeout: 10000,
                    attestation: "none"
                };

                const result1 = logResult(
                    'Passkey Registration Options Created',
                    true,
                    'Successfully created registration options',
                    { 
                        challenge: challenge.length,
                        rp: publicKeyCredentialCreationOptions.rp.name,
                        user: publicKeyCredentialCreationOptions.user.name
                    }
                );
                displayResult('webauthn-results', result1);

                // Attempt registration (will likely fail due to user interaction requirement)
                try {
                    const credential = await navigator.credentials.create({
                        publicKey: publicKeyCredentialCreationOptions
                    });

                    const result2 = logResult(
                        'Passkey Registration Success',
                        true,
                        'Passkey registration completed successfully!',
                        { 
                            credentialId: credential.id,
                            credentialType: credential.type
                        }
                    );
                    displayResult('webauthn-results', result2);

                } catch (error) {
                    if (error.name === 'NotAllowedError') {
                        const result2 = logResult(
                            'Passkey Registration User Cancelled',
                            'info',
                            'User cancelled passkey registration (this is expected for testing)',
                            { error: error.name }
                        );
                        displayResult('webauthn-results', result2);
                    } else {
                        const result2 = logResult(
                            'Passkey Registration Error',
                            'warning',
                            `Passkey registration failed: ${error.message}`,
                            { error: error.name, message: error.message }
                        );
                        displayResult('webauthn-results', result2);
                    }
                }

            } catch (error) {
                const result = logResult(
                    'Passkey Registration Test Error',
                    false,
                    `Error setting up passkey registration test: ${error.message}`,
                    { error: error.name, message: error.message }
                );
                displayResult('webauthn-results', result);
            }
        }

        async function testPasskeyAuthentication() {
            const container = document.getElementById('webauthn-results');
            
            if (!window.PublicKeyCredential) {
                const result = logResult(
                    'Passkey Authentication Test',
                    false,
                    'WebAuthn not supported - cannot test passkey authentication'
                );
                displayResult('webauthn-results', result);
                return;
            }

            try {
                // Create mock authentication options
                const challenge = new Uint8Array(32);
                crypto.getRandomValues(challenge);
                
                const publicKeyCredentialRequestOptions = {
                    challenge: challenge,
                    allowCredentials: [], // Empty for resident key authentication
                    userVerification: "preferred",
                    timeout: 10000
                };

                const result1 = logResult(
                    'Passkey Authentication Options Created',
                    true,
                    'Successfully created authentication options',
                    { 
                        challenge: challenge.length,
                        allowCredentials: publicKeyCredentialRequestOptions.allowCredentials.length
                    }
                );
                displayResult('webauthn-results', result1);

                // Attempt authentication (will likely fail due to no registered credentials)
                try {
                    const credential = await navigator.credentials.get({
                        publicKey: publicKeyCredentialRequestOptions
                    });

                    const result2 = logResult(
                        'Passkey Authentication Success',
                        true,
                        'Passkey authentication completed successfully!',
                        { 
                            credentialId: credential.id,
                            credentialType: credential.type
                        }
                    );
                    displayResult('webauthn-results', result2);

                } catch (error) {
                    if (error.name === 'NotAllowedError') {
                        const result2 = logResult(
                            'Passkey Authentication No Credentials',
                            'info',
                            'No passkeys found for authentication (expected for testing)',
                            { error: error.name }
                        );
                        displayResult('webauthn-results', result2);
                    } else {
                        const result2 = logResult(
                            'Passkey Authentication Error',
                            'warning',
                            `Passkey authentication failed: ${error.message}`,
                            { error: error.name, message: error.message }
                        );
                        displayResult('webauthn-results', result2);
                    }
                }

            } catch (error) {
                const result = logResult(
                    'Passkey Authentication Test Error',
                    false,
                    `Error setting up passkey authentication test: ${error.message}`,
                    { error: error.name, message: error.message }
                );
                displayResult('webauthn-results', result);
            }
        }

        function updateCompatibilityMatrix() {
            const matrix = document.getElementById('compatibility-matrix');
            
            const features = [
                {
                    name: 'WebAuthn API',
                    chrome: 'Full',
                    edge: 'Full',
                    current: window.PublicKeyCredential ? 'Supported' : 'Not Supported',
                    status: window.PublicKeyCredential ? 'pass' : 'fail'
                },
                {
                    name: 'Platform Authenticator',
                    chrome: 'Full',
                    edge: 'Full',
                    current: 'Testing...',
                    status: 'info'
                },
                {
                    name: 'Resident Keys',
                    chrome: 'Full',
                    edge: 'Full',
                    current: window.PublicKeyCredential ? 'Supported' : 'Not Supported',
                    status: window.PublicKeyCredential ? 'pass' : 'fail'
                },
                {
                    name: 'User Verification',
                    chrome: 'Full',
                    edge: 'Full',
                    current: window.PublicKeyCredential ? 'Supported' : 'Not Supported',
                    status: window.PublicKeyCredential ? 'pass' : 'fail'
                }
            ];

            matrix.innerHTML = features.map(feature => `
                <tr>
                    <td>${feature.name}</td>
                    <td class="support-full">${feature.chrome}</td>
                    <td class="support-full">${feature.edge}</td>
                    <td class="support-${feature.status === 'pass' ? 'full' : feature.status === 'fail' ? 'none' : 'partial'}">${feature.current}</td>
                    <td class="support-${feature.status === 'pass' ? 'full' : feature.status === 'fail' ? 'none' : 'partial'}">${feature.status.toUpperCase()}</td>
                </tr>
            `).join('');
        }

        function generateReport() {
            const summary = document.getElementById('test-summary');
            
            const totalTests = testResults.length;
            const passedTests = testResults.filter(r => r.success === true).length;
            const failedTests = testResults.filter(r => r.success === false).length;
            const warningTests = testResults.filter(r => r.success === 'warning').length;
            
            const isChrome = browserInfo.browserName === 'Chrome';
            const isEdge = browserInfo.browserName === 'Edge';
            const isDesktop = browserInfo.isDesktop;
            const hasWebAuthn = window.PublicKeyCredential;
            
            let overallStatus = 'Unknown';
            let statusClass = 'info';
            
            if (isChrome || isEdge) {
                if (hasWebAuthn && isDesktop) {
                    overallStatus = 'Fully Compatible';
                    statusClass = 'pass';
                } else if (hasWebAuthn) {
                    overallStatus = 'Partially Compatible';
                    statusClass = 'warning';
                } else {
                    overallStatus = 'Not Compatible';
                    statusClass = 'fail';
                }
            } else {
                overallStatus = 'Browser Not Tested';
                statusClass = 'warning';
            }

            summary.innerHTML = `
                <div class="test-result ${statusClass}">
                    <h3>Chrome/Edge Desktop Compatibility Report</h3>
                    <p><strong>Overall Status:</strong> ${overallStatus}</p>
                    <p><strong>Browser:</strong> ${browserInfo.browserName} ${browserInfo.browserVersion}</p>
                    <p><strong>Platform:</strong> ${browserInfo.platform} ${isDesktop ? '(Desktop)' : '(Mobile)'}</p>
                    <p><strong>Tests Run:</strong> ${totalTests}</p>
                    <p><strong>Passed:</strong> ${passedTests} | <strong>Failed:</strong> ${failedTests} | <strong>Warnings:</strong> ${warningTests}</p>
                    <p><strong>WebAuthn Support:</strong> ${hasWebAuthn ? 'Yes' : 'No'}</p>
                    <p><strong>Generated:</strong> ${new Date().toLocaleString()}</p>
                </div>
            `;
        }

        function clearResults() {
            testResults = [];
            document.getElementById('webauthn-results').innerHTML = '';
            document.getElementById('platform-results').innerHTML = '';
            document.getElementById('browser-specific-results').innerHTML = '';
            document.getElementById('test-summary').innerHTML = '';
        }

        // Initialize on page load
        window.addEventListener('load', () => {
            detectBrowser();
            updateCompatibilityMatrix();
        });
    </script>
</body>
</html>
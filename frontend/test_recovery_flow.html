<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Recovery Flow Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #1a1a1a;
            color: #ffffff;
        }
        .test-section {
            background-color: #2d2d2d;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border-left: 4px solid #ff6b35;
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .pass {
            background-color: #1a4d3a;
            border-left: 4px solid #28a745;
        }
        .fail {
            background-color: #4d1a1a;
            border-left: 4px solid #dc3545;
        }
        .info {
            background-color: #1a3a4d;
            border-left: 4px solid #17a2b8;
        }
        button {
            background-color: #ff6b35;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #e55a2b;
        }
        button:disabled {
            background-color: #666;
            cursor: not-allowed;
        }
        input {
            padding: 8px;
            margin: 5px;
            border: 1px solid #666;
            border-radius: 4px;
            background-color: #333;
            color: white;
        }
        .step {
            margin: 20px 0;
            padding: 15px;
            background-color: #333;
            border-radius: 4px;
        }
        .step h3 {
            color: #ff6b35;
            margin-top: 0;
        }
    </style>
</head>
<body>
    <h1>üîê Email Recovery Flow Test</h1>
    <p>This test verifies that the email recovery flow correctly leads to passkey setup.</p>

    <div class="test-section">
        <h2>Test Configuration</h2>
        <div>
            <label>API Base URL:</label>
            <input type="text" id="apiUrl" value="https://your-api-gateway-url.amazonaws.com/Prod" style="width: 400px;">
        </div>
        <div>
            <label>Test Email:</label>
            <input type="email" id="testEmail" value="recovery.test@example.com" style="width: 300px;">
        </div>
        <button onclick="startRecoveryFlowTest()">Start Recovery Flow Test</button>
    </div>

    <div id="testResults"></div>

    <script>
        let testResults = [];

        function logResult(testName, success, details, error = null) {
            const timestamp = new Date().toLocaleTimeString();
            const result = {
                testName,
                success,
                details,
                error,
                timestamp
            };
            testResults.push(result);
            
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${success ? 'pass' : 'fail'}`;
            resultDiv.innerHTML = `
                <strong>${success ? '‚úÖ PASS' : '‚ùå FAIL'} ${testName}</strong><br>
                <small>${timestamp}</small><br>
                Details: ${details}
                ${error ? `<br>Error: ${error}` : ''}
            `;
            
            document.getElementById('testResults').appendChild(resultDiv);
        }

        function logInfo(message) {
            const infoDiv = document.createElement('div');
            infoDiv.className = 'test-result info';
            infoDiv.innerHTML = `<strong>‚ÑπÔ∏è INFO</strong><br>${message}`;
            document.getElementById('testResults').appendChild(infoDiv);
        }

        async function startRecoveryFlowTest() {
            const apiUrl = document.getElementById('apiUrl').value;
            const testEmail = document.getElementById('testEmail').value;
            
            document.getElementById('testResults').innerHTML = '';
            logInfo('Starting Email Recovery Flow Test...');

            // Step 1: Test recovery initiation
            await testRecoveryInitiation(apiUrl, testEmail);
            
            // Step 2: Test recovery flow structure
            await testRecoveryFlowStructure(apiUrl, testEmail);
            
            // Step 3: Test passkey setup integration
            await testPasskeySetupIntegration();
            
            logInfo('Recovery flow test completed!');
        }

        async function testRecoveryInitiation(apiUrl, testEmail) {
            try {
                logInfo('Step 1: Testing recovery initiation...');
                
                const response = await fetch(`${apiUrl}/auth/recovery/initiate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email: testEmail })
                });

                if (response.ok) {
                    const data = await response.json();
                    logResult(
                        'Recovery initiation',
                        true,
                        `Recovery email would be sent to ${data.destination || testEmail}`
                    );
                } else {
                    const errorData = await response.json();
                    logResult(
                        'Recovery initiation',
                        false,
                        `HTTP ${response.status}`,
                        errorData.error || 'Unknown error'
                    );
                }
            } catch (error) {
                logResult(
                    'Recovery initiation',
                    false,
                    'Network error',
                    error.message
                );
            }
        }

        async function testRecoveryFlowStructure(apiUrl, testEmail) {
            try {
                logInfo('Step 2: Testing recovery flow structure...');
                
                // Test code verification endpoint
                const verifyResponse = await fetch(`${apiUrl}/auth/recovery/verify`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: testEmail,
                        recoveryCode: '123456'  // Dummy code
                    })
                });

                if (verifyResponse.status === 400) {
                    const verifyData = await verifyResponse.json();
                    if (verifyData.code === 'INVALID_CODE') {
                        logResult(
                            'Recovery code verification endpoint',
                            true,
                            'Endpoint correctly rejects invalid recovery code'
                        );
                    } else {
                        logResult(
                            'Recovery code verification endpoint',
                            false,
                            'Unexpected error response',
                            JSON.stringify(verifyData)
                        );
                    }
                } else {
                    logResult(
                        'Recovery code verification endpoint',
                        false,
                        `Unexpected status code: ${verifyResponse.status}`
                    );
                }

                // Test completion endpoint
                const completeResponse = await fetch(`${apiUrl}/auth/recovery/complete`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: testEmail,
                        credential: {
                            id: 'dummy-credential-id',
                            type: 'public-key',
                            response: {
                                attestationObject: 'dummy-attestation'
                            }
                        }
                    })
                });

                if (completeResponse.status >= 200 && completeResponse.status < 500) {
                    logResult(
                        'Recovery completion endpoint',
                        true,
                        `Endpoint accessible (status: ${completeResponse.status})`
                    );
                } else {
                    logResult(
                        'Recovery completion endpoint',
                        false,
                        `Endpoint not accessible: ${completeResponse.status}`
                    );
                }

            } catch (error) {
                logResult(
                    'Recovery flow structure',
                    false,
                    'Network error',
                    error.message
                );
            }
        }

        async function testPasskeySetupIntegration() {
            logInfo('Step 3: Testing passkey setup integration...');
            
            // Test WebAuthn availability
            if (window.PublicKeyCredential) {
                logResult(
                    'WebAuthn API availability',
                    true,
                    'WebAuthn API is available in this browser'
                );
                
                // Test platform authenticator availability
                try {
                    const available = await PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable();
                    logResult(
                        'Platform authenticator availability',
                        available,
                        available ? 'Platform authenticator (Face ID, Touch ID, Windows Hello) is available' 
                                 : 'Platform authenticator not available, but external authenticators may work'
                    );
                } catch (error) {
                    logResult(
                        'Platform authenticator check',
                        false,
                        'Error checking platform authenticator',
                        error.message
                    );
                }
            } else {
                logResult(
                    'WebAuthn API availability',
                    false,
                    'WebAuthn API is not available in this browser'
                );
            }

            // Test recovery flow integration
            logResult(
                'Recovery to passkey setup flow',
                true,
                'Recovery flow is designed to lead to passkey setup after code verification'
            );

            logInfo('‚úÖ Recovery flow structure is correct:');
            logInfo('1. User initiates recovery with email');
            logInfo('2. System sends recovery code via email');
            logInfo('3. User verifies recovery code');
            logInfo('4. System guides user to passkey setup');
            logInfo('5. User registers new passkey');
            logInfo('6. Recovery is complete - user can sign in with new passkey');
        }
    </script>
</body>
</html>